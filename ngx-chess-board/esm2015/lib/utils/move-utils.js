import { Bishop } from '../models/pieces/bishop';
import { King } from '../models/pieces/king';
import { Knight } from '../models/pieces/knight';
import { Pawn } from '../models/pieces/pawn';
import { Point } from '../models/pieces/point';
import { MoveTranslation } from '../models/move-translation';
import { Queen } from '../models/pieces/queen';
import { Rook } from '../models/pieces/rook';
export class MoveUtils {
    static willMoveCauseCheck(currentColor, row, col, destRow, destCol, board) {
        const srcPiece = board.getPieceByField(row, col);
        const destPiece = board.getPieceByField(destRow, destCol);
        if (srcPiece) {
            srcPiece.point.row = destRow;
            srcPiece.point.col = destCol;
        }
        if (destPiece) {
            board.pieces = board.pieces.filter((piece) => piece !== destPiece);
        }
        const isBound = board.isKingInCheck(currentColor, board.pieces);
        if (srcPiece) {
            srcPiece.point.col = col;
            srcPiece.point.row = row;
        }
        if (destPiece) {
            board.pieces.push(destPiece);
        }
        return isBound;
    }
    static format(sourcePoint, destPoint, reverted) {
        if (reverted) {
            const sourceX = 104 - sourcePoint.col;
            const destX = 104 - destPoint.col;
            return (String.fromCharCode(sourceX) +
                (sourcePoint.row + 1) +
                String.fromCharCode(destX) +
                (destPoint.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(sourcePoint.col + incrementX) +
                (Math.abs(sourcePoint.row - 7) + 1) +
                String.fromCharCode(destPoint.col + incrementX) +
                (Math.abs(destPoint.row - 7) + 1));
        }
    }
    static translateCoordsToIndex(coords, reverted) {
        let xAxis;
        let yAxis;
        if (reverted) {
            xAxis = 104 - coords.charCodeAt(0);
            yAxis = +coords.charAt(1) - 1;
        }
        else {
            xAxis = coords.charCodeAt(0) - 97;
            yAxis = Math.abs(+coords.charAt(1) - 8);
        }
        return new MoveTranslation(xAxis, yAxis, reverted);
    }
    static findPieceByPossibleMovesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleMoves()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        if (foundPieces.length === 0) {
            console.log(coords + ' debug');
        }
        return foundPieces;
    }
    static findPieceByPossibleCapturesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleCaptures()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        if (foundPieces.length === 0) {
            console.log(coords + ' debug');
        }
        return foundPieces;
    }
    static formatSingle(point, reverted) {
        if (reverted) {
            const sourceX = 104 - point.col;
            return (String.fromCharCode(sourceX) +
                (point.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(point.col + incrementX) +
                (Math.abs(point.row - 7) + 1));
        }
    }
    static getFirstLetterPiece(piece) {
        if (piece instanceof Pawn) {
            return 'P';
        }
        else {
            if (piece instanceof Knight) {
                return 'N';
            }
            else {
                if (piece instanceof Bishop) {
                    return 'B';
                }
                else {
                    if (piece instanceof Rook) {
                        return 'R';
                    }
                    else {
                        if (piece instanceof King) {
                            return 'K';
                        }
                        else {
                            if (piece instanceof Queen) {
                                return 'Q';
                            }
                        }
                    }
                }
            }
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9Lb21wdXRlci9EZXNrdG9wL05vd3kgZm9sZGVyL2NoZXNzLWJvYXJkL3Byb2plY3RzL25neC1jaGVzcy1ib2FyZC9zcmMvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvbW92ZS11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFakQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9DLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTdDLE1BQU0sT0FBTyxTQUFTO0lBQ1gsTUFBTSxDQUFDLGtCQUFrQixDQUM1QixZQUFtQixFQUNuQixHQUFXLEVBQ1gsR0FBVyxFQUNYLE9BQWUsRUFDZixPQUFlLEVBQ2YsS0FBWTtRQUVaLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRTFELElBQUksUUFBUSxFQUFFO1lBQ1YsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDO1lBQzdCLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztTQUNoQztRQUVELElBQUks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QztTQUNMO0lBQ0wsQ0FBQztJQUVNLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFZO1FBQzFDLElBQUksS0FBSyxZQUFZLElBQUksRUFBRTtZQUN2QixPQUFPLEdBQUcsQ0FBQztTQUNkO2FBQU07WUFDSCxJQUFJLEtBQUssWUFBWSxNQUFNLEVBQUU7Z0JBQ3pCLE9BQU8sR0FBRyxDQUFDO2FBQ2Q7aUJBQU07Z0JBQ0gsSUFBSSxLQUFLLFlBQVksTUFBTSxFQUFFO29CQUN6QixPQUFPLEdBQUcsQ0FBQztpQkFDZDtxQkFBTTtvQkFDSCxJQUFJLEtBQUssWUFBWSxJQUFJLEVBQUU7d0JBQ3ZCLE9BQU8sR0FBRyxDQUFDO3FCQUNkO3lCQUFNO3dCQUNILElBQUksS0FBSyxZQUFZLElBQUksRUFBRTs0QkFDdkIsT0FBTyxHQUFHLENBQUM7eUJBQ2Q7NkJBQU07NEJBQ0gsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUFFO2dDQUN4QixPQUFPLEdBQUcsQ0FBQzs2QkFDZDt5QkFDSjtxQkFDSjtpQkFDSjthQUNKO1NBQ0o7UUFFRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvYXJkIH0gZnJvbSAnLi4vbW9kZWxzL2JvYXJkJztcclxuaW1wb3J0IHsgQmlzaG9wIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9iaXNob3AnO1xyXG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvY29sb3InO1xyXG5pbXBvcnQgeyBLaW5nIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9raW5nJztcclxuaW1wb3J0IHsgS25pZ2h0IH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9rbmlnaHQnO1xyXG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcclxuaW1wb3J0IHsgUGllY2UgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3BpZWNlJztcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3BvaW50JztcclxuaW1wb3J0IHsgTW92ZVRyYW5zbGF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL21vdmUtdHJhbnNsYXRpb24nO1xyXG5pbXBvcnQgeyBRdWVlbiB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvcXVlZW4nO1xyXG5pbXBvcnQgeyBSb29rIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9yb29rJztcclxuXHJcbmV4cG9ydCBjbGFzcyBNb3ZlVXRpbHMge1xyXG4gICAgcHVibGljIHN0YXRpYyB3aWxsTW92ZUNhdXNlQ2hlY2soXHJcbiAgICAgICAgY3VycmVudENvbG9yOiBDb2xvcixcclxuICAgICAgICByb3c6IG51bWJlcixcclxuICAgICAgICBjb2w6IG51bWJlcixcclxuICAgICAgICBkZXN0Um93OiBudW1iZXIsXHJcbiAgICAgICAgZGVzdENvbDogbnVtYmVyLFxyXG4gICAgICAgIGJvYXJkOiBCb2FyZFxyXG4gICAgKSB7XHJcbiAgICAgICAgY29uc3Qgc3JjUGllY2UgPSBib2FyZC5nZXRQaWVjZUJ5RmllbGQocm93LCBjb2wpO1xyXG4gICAgICAgIGNvbnN0IGRlc3RQaWVjZSA9IGJvYXJkLmdldFBpZWNlQnlGaWVsZChkZXN0Um93LCBkZXN0Q29sKTtcclxuXHJcbiAgICAgICAgaWYgKHNyY1BpZWNlKSB7XHJcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LnJvdyA9IGRlc3RSb3c7XHJcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LmNvbCA9IGRlc3RDb2w7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZGVzdFBpZWNlKSB7XHJcbiAgICAgICAgICAgIGJvYXJkLnBpZWNlcyA9IGJvYXJkLnBpZWNlcy5maWx0ZXIoKHBpZWNlKSA9PiBwaWVjZSAhPT0gZGVzdFBpZWNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXNCb3VuZCA9IGJvYXJkLmlzS2luZ0luQ2hlY2soY3VycmVudENvbG9yLCBib2FyZC5waWVjZXMpO1xyXG5cclxuICAgICAgICBpZiAoc3JjUGllY2UpIHtcclxuICAgICAgICAgICAgc3JjUGllY2UucG9pbnQuY29sID0gY29sO1xyXG4gICAgICAgICAgICBzcmNQaWVjZS5wb2ludC5yb3cgPSByb3c7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZGVzdFBpZWNlKSB7XHJcbiAgICAgICAgICAgIGJvYXJkLnBpZWNlcy5wdXNoKGRlc3RQaWVjZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaXNCb3VuZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGZvcm1hdChcclxuICAgICAgICBzb3VyY2VQb2ludDogUG9pbnQsXHJcbiAgICAgICAgZGVzdFBvaW50OiBQb2ludCxcclxuICAgICAgICByZXZlcnRlZDogYm9vbGVhblxyXG4gICAgKSB7XHJcbiAgICAgICAgaWYgKHJldmVydGVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZVggPSAxMDQgLSBzb3VyY2VQb2ludC5jb2w7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc3RYID0gMTA0IC0gZGVzdFBvaW50LmNvbDtcclxuICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlWCkgK1xyXG4gICAgICAgICAgICAgICAgKHNvdXJjZVBvaW50LnJvdyArIDEpICtcclxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoZGVzdFgpICtcclxuICAgICAgICAgICAgICAgIChkZXN0UG9pbnQucm93ICsgMSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBpbmNyZW1lbnRYID0gOTc7XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKHNvdXJjZVBvaW50LmNvbCArIGluY3JlbWVudFgpICtcclxuICAgICAgICAgICAgICAgIChNYXRoLmFicyhzb3VyY2VQb2ludC5yb3cgLSA3KSArIDEpICtcclxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoZGVzdFBvaW50LmNvbCArIGluY3JlbWVudFgpICtcclxuICAgICAgICAgICAgICAgIChNYXRoLmFicyhkZXN0UG9pbnQucm93IC0gNykgKyAxKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIHRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgoY29vcmRzOiBzdHJpbmcsIHJldmVydGVkOiBib29sZWFuKSB7XHJcbiAgICAgICAgbGV0IHhBeGlzOiBudW1iZXI7XHJcbiAgICAgICAgbGV0IHlBeGlzOiBudW1iZXI7XHJcbiAgICAgICAgaWYgKHJldmVydGVkKSB7XHJcbiAgICAgICAgICAgIHhBeGlzID0gMTA0IC0gY29vcmRzLmNoYXJDb2RlQXQoMCk7XHJcbiAgICAgICAgICAgIHlBeGlzID0gK2Nvb3Jkcy5jaGFyQXQoMSkgLSAxO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHhBeGlzID0gY29vcmRzLmNoYXJDb2RlQXQoMCkgLSA5NztcclxuICAgICAgICAgICAgeUF4aXMgPSBNYXRoLmFicygrY29vcmRzLmNoYXJBdCgxKSAtIDgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBNb3ZlVHJhbnNsYXRpb24oeEF4aXMsIHlBeGlzLCByZXZlcnRlZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBmaW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxyXG4gICAgICAgIGNvb3Jkczogc3RyaW5nLFxyXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcclxuICAgICAgICBjb2xvcjogQ29sb3JcclxuICAgICk6IFBpZWNlW10ge1xyXG4gICAgICAgIGxldCBpbmRleGVzID0gdGhpcy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xyXG4gICAgICAgIGxldCBkZXN0UG9pbnQgPSBuZXcgUG9pbnQoaW5kZXhlcy55QXhpcywgaW5kZXhlcy54QXhpcyk7XHJcbiAgICAgICAgbGV0IGZvdW5kUGllY2VzID0gW107XHJcblxyXG4gICAgICAgIGZvciAobGV0IHBpZWNlIG9mIGJvYXJkLnBpZWNlcy5maWx0ZXIocGllY2UgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yKSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwb2ludCBvZiBwaWVjZS5nZXRQb3NzaWJsZU1vdmVzKCkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghTW92ZVV0aWxzLndpbGxNb3ZlQ2F1c2VDaGVjayhcclxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5jb2xvcixcclxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3csXHJcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQuY29sLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueUF4aXMsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy54QXhpcyxcclxuICAgICAgICAgICAgICAgICAgICBib2FyZFxyXG4gICAgICAgICAgICAgICAgKSAmJiBwb2ludC5pc0VxdWFsKGRlc3RQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlcy5wdXNoKHBpZWNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZm91bmRQaWVjZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvb3JkcyArICcgZGVidWcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZvdW5kUGllY2VzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcclxuICAgICAgICBjb29yZHM6IHN0cmluZyxcclxuICAgICAgICBib2FyZDogQm9hcmQsXHJcbiAgICAgICAgY29sb3I6IENvbG9yXHJcbiAgICApOiBQaWVjZVtdIHtcclxuICAgICAgICBsZXQgaW5kZXhlcyA9IHRoaXMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHMsIGJvYXJkLnJldmVydGVkKTtcclxuICAgICAgICBsZXQgZGVzdFBvaW50ID0gbmV3IFBvaW50KGluZGV4ZXMueUF4aXMsIGluZGV4ZXMueEF4aXMpO1xyXG4gICAgICAgIGxldCBmb3VuZFBpZWNlcyA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IHBpZWNlIG9mIGJvYXJkLnBpZWNlcy5maWx0ZXIocGllY2UgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yKSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwb2ludCBvZiBwaWVjZS5nZXRQb3NzaWJsZUNhcHR1cmVzKCkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghTW92ZVV0aWxzLndpbGxNb3ZlQ2F1c2VDaGVjayhcclxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5jb2xvcixcclxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3csXHJcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQuY29sLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueUF4aXMsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy54QXhpcyxcclxuICAgICAgICAgICAgICAgICAgICBib2FyZFxyXG4gICAgICAgICAgICAgICAgKSAmJiBwb2ludC5pc0VxdWFsKGRlc3RQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlcy5wdXNoKHBpZWNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZm91bmRQaWVjZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvb3JkcyArICcgZGVidWcnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBmb3VuZFBpZWNlcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGZvcm1hdFNpbmdsZShwb2ludDogUG9pbnQsIHJldmVydGVkOiBib29sZWFuKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAocmV2ZXJ0ZWQpIHtcclxuICAgICAgICAgICAgY29uc3Qgc291cmNlWCA9IDEwNCAtIHBvaW50LmNvbDtcclxuICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlWCkgK1xyXG4gICAgICAgICAgICAgICAgKHBvaW50LnJvdyArIDEpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgaW5jcmVtZW50WCA9IDk3O1xyXG4gICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShwb2ludC5jb2wgKyBpbmNyZW1lbnRYKSArXHJcbiAgICAgICAgICAgICAgICAoTWF0aC5hYnMocG9pbnQucm93IC0gNykgKyAxKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldEZpcnN0TGV0dGVyUGllY2UocGllY2U6IFBpZWNlKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBQYXduKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnUCc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgS25pZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ04nO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgQmlzaG9wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdCJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUm9vaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ1InO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnSyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnUSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbn1cclxuIl19