import { Point } from '../models/pieces/point';
import { MoveTranslation } from '../models/move-translation';
export class MoveUtils {
    static willMoveCauseCheck(currentColor, row, col, destRow, destCol, board) {
        const srcPiece = board.getPieceByField(row, col);
        const destPiece = board.getPieceByField(destRow, destCol);
        if (srcPiece) {
            srcPiece.point.row = destRow;
            srcPiece.point.col = destCol;
        }
        if (destPiece) {
            board.pieces = board.pieces.filter((piece) => piece !== destPiece);
        }
        const isBound = board.isKingInCheck(currentColor, board.pieces);
        if (srcPiece) {
            srcPiece.point.col = col;
            srcPiece.point.row = row;
        }
        if (destPiece) {
            board.pieces.push(destPiece);
        }
        return isBound;
    }
    static format(sourcePoint, destPoint, reverted) {
        if (reverted) {
            const sourceX = 104 - sourcePoint.col;
            const destX = 104 - destPoint.col;
            return (String.fromCharCode(sourceX) +
                (sourcePoint.row + 1) +
                String.fromCharCode(destX) +
                (destPoint.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(sourcePoint.col + incrementX) +
                (Math.abs(sourcePoint.row - 7) + 1) +
                String.fromCharCode(destPoint.col + incrementX) +
                (Math.abs(destPoint.row - 7) + 1));
        }
    }
    static translateCoordsToIndex(coords, reverted) {
        let xAxis;
        let yAxis;
        if (reverted) {
            xAxis = 104 - coords.charCodeAt(0);
            yAxis = +coords.charAt(1) - 1;
        }
        else {
            xAxis = coords.charCodeAt(0) - 97;
            yAxis = Math.abs(+coords.charAt(1) - 8);
        }
        return new MoveTranslation(xAxis, yAxis, reverted);
    }
    static findPieceByPossibleMovesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleMoves()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        if (foundPieces.length === 0) {
            console.log(coords + ' debug');
        }
        return foundPieces;
    }
    static findPieceByPossibleCapturesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleCaptures()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        if (foundPieces.length === 0) {
            console.log(coords + ' debug');
        }
        return foundPieces;
    }
    static formatSingle(point, reverted) {
        if (reverted) {
            const sourceX = 104 - point.col;
            return (String.fromCharCode(sourceX) +
                (point.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(point.col + incrementX) +
                (Math.abs(point.row - 7) + 1));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9Lb21wdXRlci9EZXNrdG9wL05vd3kgZm9sZGVyL2NoZXNzLWJvYXJkL3Byb2plY3RzL25neC1jaGVzcy1ib2FyZC9zcmMvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvbW92ZS11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTdELE1BQU0sT0FBTyxTQUFTO0lBQ1gsTUFBTSxDQUFDLGtCQUFrQixDQUM1QixZQUFtQixFQUNuQixHQUFXLEVBQ1gsR0FBVyxFQUNYLE9BQWUsRUFDZixPQUFlLEVBQ2YsS0FBWTtRQUVaLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRTFELElBQUksUUFBUSxFQUFFO1lBQ1YsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDO1lBQzdCLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztTQUNoQztRQUVELElBQUksU0FBUyxFQUFFO1lBQ1gsS0FBSyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDO1NBQ3RFO1FBQ0QsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWhFLElBQUksUUFBUSxFQUFFO1lBQ1YsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxD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YixLQUFLLENBQ1IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUMzQixXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUMzQjthQUNKO1NBQ0o7UUFDRCxJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzFCLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBWSxFQUFFLFFBQWlCO1FBQ3RELElBQUksUUFBUSxFQUFFO1lBQ1YsTUFBTSxPQUFPLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7WUFDaEMsT0FBTyxDQUNILE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDO2dCQUM1QixDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQ2xCLENBQUM7U0FDTDthQUFNO1lBQ0gsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLE9BQU8sQ0FDSCxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsVUFBVSxDQUFDO2dCQUMzQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDaEMsQ0FBQztTQUNMO0lBQ0wsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuLi9tb2RlbHMvYm9hcmQnO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2NvbG9yJztcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2tpbmcnO1xuaW1wb3J0IHsgS25pZ2h0IH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9rbmlnaHQnO1xuaW1wb3J0IHsgUGllY2UgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3BpZWNlJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9wb2ludCc7XG5pbXBvcnQgeyBNb3ZlVHJhbnNsYXRpb24gfSBmcm9tICcuLi9tb2RlbHMvbW92ZS10cmFuc2xhdGlvbic7XG5cbmV4cG9ydCBjbGFzcyBNb3ZlVXRpbHMge1xuICAgIHB1YmxpYyBzdGF0aWMgd2lsbE1vdmVDYXVzZUNoZWNrKFxuICAgICAgICBjdXJyZW50Q29sb3I6IENvbG9yLFxuICAgICAgICByb3c6IG51bWJlcixcbiAgICAgICAgY29sOiBudW1iZXIsXG4gICAgICAgIGRlc3RSb3c6IG51bWJlcixcbiAgICAgICAgZGVzdENvbDogbnVtYmVyLFxuICAgICAgICBib2FyZDogQm9hcmRcbiAgICApIHtcbiAgICAgICAgY29uc3Qgc3JjUGllY2UgPSBib2FyZC5nZXRQaWVjZUJ5RmllbGQocm93LCBjb2wpO1xuICAgICAgICBjb25zdCBkZXN0UGllY2UgPSBib2FyZC5nZXRQaWVjZUJ5RmllbGQoZGVzdFJvdywgZGVzdENvbCk7XG5cbiAgICAgICAgaWYgKHNyY1BpZWNlKSB7XG4gICAgICAgICAgICBzcmNQaWVjZS5wb2ludC5yb3cgPSBkZXN0Um93O1xuICAgICAgICAgICAgc3JjUGllY2UucG9pbnQuY29sID0gZGVzdENvbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkZXN0UGllY2UpIHtcbiAgICAgICAgICAgIGJvYXJkLnBpZWNlcyA9IGJvYXJkLnBpZWNlcy5maWx0ZXIoKHBpZWNlKSA9PiBwaWVjZSAhPT0gZGVzdFBpZWNlKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpc0JvdW5kID0gYm9hcmQuaXNLaW5nSW5DaGVjayhjdXJyZW50Q29sb3IsIGJvYXJkLnBpZWNlcyk7XG5cbiAgICAgICAgaWYgKHNyY1BpZWNlKSB7XG4gICAgICAgICAgICBzcmNQaWVjZS5wb2ludC5jb2wgPSBjb2w7XG4gICAgICAgICAgICBzcmNQaWVjZS5wb2ludC5yb3cgPSByb3c7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVzdFBpZWNlKSB7XG4gICAgICAgICAgICBib2FyZC5waWVjZXMucHVzaChkZXN0UGllY2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlzQm91bmQ7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmb3JtYXQoXG4gICAgICAgIHNvdXJjZVBvaW50OiBQb2ludCxcbiAgICAgICAgZGVzdFBvaW50OiBQb2ludCxcbiAgICAgICAgcmV2ZXJ0ZWQ6IGJvb2xlYW5cbiAgICApIHtcbiAgICAgICAgaWYgKHJldmVydGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzb3VyY2VYID0gMTA0IC0gc291cmNlUG9pbnQuY29sO1xuICAgICAgICAgICAgY29uc3QgZGVzdFggPSAxMDQgLSBkZXN0UG9pbnQuY29sO1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKHNvdXJjZVgpICtcbiAgICAgICAgICAgICAgICAoc291cmNlUG9pbnQucm93ICsgMSkgK1xuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoZGVzdFgpICtcbiAgICAgICAgICAgICAgICAoZGVzdFBvaW50LnJvdyArIDEpXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgaW5jcmVtZW50WCA9IDk3O1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKHNvdXJjZVBvaW50LmNvbCArIGluY3JlbWVudFgpICtcbiAgICAgICAgICAgICAgICAoTWF0aC5hYnMoc291cmNlUG9pbnQucm93IC0gNykgKyAxKSArXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShkZXN0UG9pbnQuY29sICsgaW5jcmVtZW50WCkgK1xuICAgICAgICAgICAgICAgIChNYXRoLmFicyhkZXN0UG9pbnQucm93IC0gNykgKyAxKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgdHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHM6IHN0cmluZywgcmV2ZXJ0ZWQ6IGJvb2xlYW4pIHtcbiAgICAgICAgbGV0IHhBeGlzOiBudW1iZXI7XG4gICAgICAgIGxldCB5QXhpczogbnVtYmVyO1xuICAgICAgICBpZiAocmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIHhBeGlzID0gMTA0IC0gY29vcmRzLmNoYXJDb2RlQXQoMCk7XG4gICAgICAgICAgICB5QXhpcyA9ICtjb29yZHMuY2hhckF0KDEpIC0gMTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHhBeGlzID0gY29vcmRzLmNoYXJDb2RlQXQoMCkgLSA5NztcbiAgICAgICAgICAgIHlBeGlzID0gTWF0aC5hYnMoK2Nvb3Jkcy5jaGFyQXQoMSkgLSA4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgTW92ZVRyYW5zbGF0aW9uKHhBeGlzLCB5QXhpcywgcmV2ZXJ0ZWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgY29vcmRzOiBzdHJpbmcsXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcbiAgICAgICAgY29sb3I6IENvbG9yXG4gICAgKTogUGllY2VbXSB7XG4gICAgICAgIGxldCBpbmRleGVzID0gdGhpcy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xuICAgICAgICBsZXQgZGVzdFBvaW50ID0gbmV3IFBvaW50KGluZGV4ZXMueUF4aXMsIGluZGV4ZXMueEF4aXMpO1xuICAgICAgICBsZXQgZm91bmRQaWVjZXMgPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBwaWVjZSBvZiBib2FyZC5waWVjZXMuZmlsdGVyKHBpZWNlID0+IHBpZWNlLmNvbG9yID09PSBjb2xvcikpIHtcbiAgICAgICAgICAgIGZvciAobGV0IHBvaW50IG9mIHBpZWNlLmdldFBvc3NpYmxlTW92ZXMoKSkge1xuICAgICAgICAgICAgICAgIGlmICghTW92ZVV0aWxzLndpbGxNb3ZlQ2F1c2VDaGVjayhcbiAgICAgICAgICAgICAgICAgICAgcGllY2UuY29sb3IsXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LnJvdyxcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQuY29sLFxuICAgICAgICAgICAgICAgICAgICBpbmRleGVzLnlBeGlzLFxuICAgICAgICAgICAgICAgICAgICBpbmRleGVzLnhBeGlzLFxuICAgICAgICAgICAgICAgICAgICBib2FyZFxuICAgICAgICAgICAgICAgICkgJiYgcG9pbnQuaXNFcXVhbChkZXN0UG9pbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvdW5kUGllY2VzLnB1c2gocGllY2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZm91bmRQaWVjZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjb29yZHMgKyAnIGRlYnVnJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvdW5kUGllY2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgY29vcmRzOiBzdHJpbmcsXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcbiAgICAgICAgY29sb3I6IENvbG9yXG4gICAgKTogUGllY2VbXSB7XG4gICAgICAgIGxldCBpbmRleGVzID0gdGhpcy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xuICAgICAgICBsZXQgZGVzdFBvaW50ID0gbmV3IFBvaW50KGluZGV4ZXMueUF4aXMsIGluZGV4ZXMueEF4aXMpO1xuICAgICAgICBsZXQgZm91bmRQaWVjZXMgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgcGllY2Ugb2YgYm9hcmQucGllY2VzLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IpKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBwb2ludCBvZiBwaWVjZS5nZXRQb3NzaWJsZUNhcHR1cmVzKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIU1vdmVVdGlscy53aWxsTW92ZUNhdXNlQ2hlY2soXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLmNvbG9yLFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3csXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LmNvbCxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy55QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy54QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgYm9hcmRcbiAgICAgICAgICAgICAgICApICYmIHBvaW50LmlzRXF1YWwoZGVzdFBvaW50KSkge1xuICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlcy5wdXNoKHBpZWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvdW5kUGllY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coY29vcmRzICsgJyBkZWJ1ZycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZvdW5kUGllY2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZm9ybWF0U2luZ2xlKHBvaW50OiBQb2ludCwgcmV2ZXJ0ZWQ6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgICAgICBpZiAocmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZVggPSAxMDQgLSBwb2ludC5jb2w7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlWCkgK1xuICAgICAgICAgICAgICAgIChwb2ludC5yb3cgKyAxKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGluY3JlbWVudFggPSA5NztcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShwb2ludC5jb2wgKyBpbmNyZW1lbnRYKSArXG4gICAgICAgICAgICAgICAgKE1hdGguYWJzKHBvaW50LnJvdyAtIDcpICsgMSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==