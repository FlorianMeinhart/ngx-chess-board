import { Bishop } from '../models/pieces/bishop';
import { King } from '../models/pieces/king';
import { Knight } from '../models/pieces/knight';
import { Pawn } from '../models/pieces/pawn';
import { Point } from '../models/pieces/point';
import { MoveTranslation } from '../models/move-translation';
import { Queen } from '../models/pieces/queen';
import { Rook } from '../models/pieces/rook';
export class MoveUtils {
    static willMoveCauseCheck(currentColor, row, col, destRow, destCol, board) {
        const srcPiece = board.getPieceByField(row, col);
        const destPiece = board.getPieceByField(destRow, destCol);
        if (srcPiece) {
            srcPiece.point.row = destRow;
            srcPiece.point.col = destCol;
        }
        if (destPiece) {
            board.pieces = board.pieces.filter((piece) => piece !== destPiece);
        }
        const isBound = board.isKingInCheck(currentColor, board.pieces);
        if (srcPiece) {
            srcPiece.point.col = col;
            srcPiece.point.row = row;
        }
        if (destPiece) {
            board.pieces.push(destPiece);
        }
        return isBound;
    }
    static format(sourcePoint, destPoint, reverted) {
        if (reverted) {
            const sourceX = 104 - sourcePoint.col;
            const destX = 104 - destPoint.col;
            return (String.fromCharCode(sourceX) +
                (sourcePoint.row + 1) +
                String.fromCharCode(destX) +
                (destPoint.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(sourcePoint.col + incrementX) +
                (Math.abs(sourcePoint.row - 7) + 1) +
                String.fromCharCode(destPoint.col + incrementX) +
                (Math.abs(destPoint.row - 7) + 1));
        }
    }
    static translateCoordsToIndex(coords, reverted) {
        let xAxis;
        let yAxis;
        if (reverted) {
            xAxis = 104 - coords.charCodeAt(0);
            yAxis = +coords.charAt(1) - 1;
        }
        else {
            xAxis = coords.charCodeAt(0) - 97;
            yAxis = Math.abs(+coords.charAt(1) - 8);
        }
        return new MoveTranslation(xAxis, yAxis, reverted);
    }
    static findPieceByPossibleMovesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleMoves()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        return foundPieces;
    }
    static findPieceByPossibleCapturesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleCaptures()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        return foundPieces;
    }
    static formatSingle(point, reverted) {
        if (reverted) {
            const sourceX = 104 - point.col;
            return (String.fromCharCode(sourceX) +
                (point.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(point.col + incrementX) +
                (Math.abs(point.row - 7) + 1));
        }
    }
    static getFirstLetterPiece(piece) {
        if (piece instanceof Pawn) {
            return 'P';
        }
        else {
            if (piece instanceof Knight) {
                return 'N';
            }
            else {
                if (piece instanceof Bishop) {
                    return 'B';
                }
                else {
                    if (piece instanceof Rook) {
                        return 'R';
                    }
                    else {
                        if (piece instanceof King) {
                            return 'K';
                        }
                        else {
                            if (piece instanceof Queen) {
                                return 'Q';
                            }
                        }
                    }
                }
            }
        }
        return '';
    }
    static reverse(board, row) {
        return board.reverted
            ? row + 1
            : Math.abs(row - 7) + 1;
    }
    static formatCol(board, col) {
        return board.reverted
            ? String.fromCharCode(104 - col)
            : String.fromCharCode(97 + col);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9Lb21wdXRlci9EZXNrdG9wL05vd3kgZm9sZGVyL2NoZXNzLWJvYXJkL3Byb2plY3RzL25neC1jaGVzcy1ib2FyZC9zcmMvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvbW92ZS11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFakQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9DLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTdDLE1BQU0sT0FBTyxTQUFTO0lBQ1gsTUFBTSxDQUFDLGtCQUFrQixDQUM1QixZQUFtQixFQUNuQixHQUFXLEVBQ1gsR0FBVyxFQUNYLE9BQWUsRUFDZixPQUFlLEVBQ2YsS0FBWTtRQUVaLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRTFELElBQUksUUFBUSxFQUFFO1lBQ1YsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDO1lBQzdCLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztTQUNoQztRQUVELElBQUks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LE1BQU0sRUFBRTtvQkFDekIsT0FBTyxHQUFHLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0gsSUFBSSxLQUFLLFlBQVksSUFBSSxFQUFFO3dCQUN2QixPQUFPLEdBQUcsQ0FBQztxQkFDZDt5QkFBTTt3QkFDSCxJQUFJLEtBQUssWUFBWSxJQUFJLEVBQUU7NEJBQ3ZCLE9BQU8sR0FBRyxDQUFDO3lCQUNkOzZCQUFNOzRCQUNILElBQUksS0FBSyxZQUFZLEtBQUssRUFBRTtnQ0FDeEIsT0FBTyxHQUFHLENBQUM7NkJBQ2Q7eUJBQ0o7cUJBQ0o7aUJBQ0o7YUFDSjtTQUNKO1FBRUQsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFZLEVBQUUsR0FBVztRQUNwQyxPQUFPLEtBQUssQ0FBQyxRQUFRO1lBQ2pCLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUNULENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsS0FBWSxFQUFFLEdBQVc7UUFDdEMsT0FBTyxLQUFLLENBQUMsUUFBUTtZQUNqQixDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1lBQ2hDLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUN4QyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb2FyZCB9IGZyb20gJy4uL21vZGVscy9ib2FyZCc7XG5pbXBvcnQgeyBCaXNob3AgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2Jpc2hvcCc7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvY29sb3InO1xuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uL21vZGVscy9waWVjZXMva2luZyc7XG5pbXBvcnQgeyBLbmlnaHQgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2tuaWdodCc7XG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvcG9pbnQnO1xuaW1wb3J0IHsgTW92ZVRyYW5zbGF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL21vdmUtdHJhbnNsYXRpb24nO1xuaW1wb3J0IHsgUXVlZW4gfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3F1ZWVuJztcbmltcG9ydCB7IFJvb2sgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3Jvb2snO1xuXG5leHBvcnQgY2xhc3MgTW92ZVV0aWxzIHtcbiAgICBwdWJsaWMgc3RhdGljIHdpbGxNb3ZlQ2F1c2VDaGVjayhcbiAgICAgICAgY3VycmVudENvbG9yOiBDb2xvcixcbiAgICAgICAgcm93OiBudW1iZXIsXG4gICAgICAgIGNvbDogbnVtYmVyLFxuICAgICAgICBkZXN0Um93OiBudW1iZXIsXG4gICAgICAgIGRlc3RDb2w6IG51bWJlcixcbiAgICAgICAgYm9hcmQ6IEJvYXJkXG4gICAgKSB7XG4gICAgICAgIGNvbnN0IHNyY1BpZWNlID0gYm9hcmQuZ2V0UGllY2VCeUZpZWxkKHJvdywgY29sKTtcbiAgICAgICAgY29uc3QgZGVzdFBpZWNlID0gYm9hcmQuZ2V0UGllY2VCeUZpZWxkKGRlc3RSb3csIGRlc3RDb2wpO1xuXG4gICAgICAgIGlmIChzcmNQaWVjZSkge1xuICAgICAgICAgICAgc3JjUGllY2UucG9pbnQucm93ID0gZGVzdFJvdztcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LmNvbCA9IGRlc3RDb2w7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVzdFBpZWNlKSB7XG4gICAgICAgICAgICBib2FyZC5waWVjZXMgPSBib2FyZC5waWVjZXMuZmlsdGVyKChwaWVjZSkgPT4gcGllY2UgIT09IGRlc3RQaWVjZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaXNCb3VuZCA9IGJvYXJkLmlzS2luZ0luQ2hlY2soY3VycmVudENvbG9yLCBib2FyZC5waWVjZXMpO1xuXG4gICAgICAgIGlmIChzcmNQaWVjZSkge1xuICAgICAgICAgICAgc3JjUGllY2UucG9pbnQuY29sID0gY29sO1xuICAgICAgICAgICAgc3JjUGllY2UucG9pbnQucm93ID0gcm93O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlc3RQaWVjZSkge1xuICAgICAgICAgICAgYm9hcmQucGllY2VzLnB1c2goZGVzdFBpZWNlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpc0JvdW5kO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZm9ybWF0KFxuICAgICAgICBzb3VyY2VQb2ludDogUG9pbnQsXG4gICAgICAgIGRlc3RQb2ludDogUG9pbnQsXG4gICAgICAgIHJldmVydGVkOiBib29sZWFuXG4gICAgKSB7XG4gICAgICAgIGlmIChyZXZlcnRlZCkge1xuICAgICAgICAgICAgY29uc3Qgc291cmNlWCA9IDEwNCAtIHNvdXJjZVBvaW50LmNvbDtcbiAgICAgICAgICAgIGNvbnN0IGRlc3RYID0gMTA0IC0gZGVzdFBvaW50LmNvbDtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShzb3VyY2VYKSArXG4gICAgICAgICAgICAgICAgKHNvdXJjZVBvaW50LnJvdyArIDEpICtcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKGRlc3RYKSArXG4gICAgICAgICAgICAgICAgKGRlc3RQb2ludC5yb3cgKyAxKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGluY3JlbWVudFggPSA5NztcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShzb3VyY2VQb2ludC5jb2wgKyBpbmNyZW1lbnRYKSArXG4gICAgICAgICAgICAgICAgKE1hdGguYWJzKHNvdXJjZVBvaW50LnJvdyAtIDcpICsgMSkgK1xuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoZGVzdFBvaW50LmNvbCArIGluY3JlbWVudFgpICtcbiAgICAgICAgICAgICAgICAoTWF0aC5hYnMoZGVzdFBvaW50LnJvdyAtIDcpICsgMSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgoY29vcmRzOiBzdHJpbmcsIHJldmVydGVkOiBib29sZWFuKSB7XG4gICAgICAgIGxldCB4QXhpczogbnVtYmVyO1xuICAgICAgICBsZXQgeUF4aXM6IG51bWJlcjtcbiAgICAgICAgaWYgKHJldmVydGVkKSB7XG4gICAgICAgICAgICB4QXhpcyA9IDEwNCAtIGNvb3Jkcy5jaGFyQ29kZUF0KDApO1xuICAgICAgICAgICAgeUF4aXMgPSArY29vcmRzLmNoYXJBdCgxKSAtIDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB4QXhpcyA9IGNvb3Jkcy5jaGFyQ29kZUF0KDApIC0gOTc7XG4gICAgICAgICAgICB5QXhpcyA9IE1hdGguYWJzKCtjb29yZHMuY2hhckF0KDEpIC0gOCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IE1vdmVUcmFuc2xhdGlvbih4QXhpcywgeUF4aXMsIHJldmVydGVkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgIGNvb3Jkczogc3RyaW5nLFxuICAgICAgICBib2FyZDogQm9hcmQsXG4gICAgICAgIGNvbG9yOiBDb2xvclxuICAgICk6IFBpZWNlW10ge1xuICAgICAgICBsZXQgaW5kZXhlcyA9IHRoaXMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHMsIGJvYXJkLnJldmVydGVkKTtcbiAgICAgICAgbGV0IGRlc3RQb2ludCA9IG5ldyBQb2ludChpbmRleGVzLnlBeGlzLCBpbmRleGVzLnhBeGlzKTtcbiAgICAgICAgbGV0IGZvdW5kUGllY2VzID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgcGllY2Ugb2YgYm9hcmQucGllY2VzLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IpKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBwb2ludCBvZiBwaWVjZS5nZXRQb3NzaWJsZU1vdmVzKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIU1vdmVVdGlscy53aWxsTW92ZUNhdXNlQ2hlY2soXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLmNvbG9yLFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3csXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LmNvbCxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy55QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy54QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgYm9hcmRcbiAgICAgICAgICAgICAgICApICYmIHBvaW50LmlzRXF1YWwoZGVzdFBvaW50KSkge1xuICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlcy5wdXNoKHBpZWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvdW5kUGllY2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgY29vcmRzOiBzdHJpbmcsXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcbiAgICAgICAgY29sb3I6IENvbG9yXG4gICAgKTogUGllY2VbXSB7XG4gICAgICAgIGxldCBpbmRleGVzID0gdGhpcy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xuICAgICAgICBsZXQgZGVzdFBvaW50ID0gbmV3IFBvaW50KGluZGV4ZXMueUF4aXMsIGluZGV4ZXMueEF4aXMpO1xuICAgICAgICBsZXQgZm91bmRQaWVjZXMgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgcGllY2Ugb2YgYm9hcmQucGllY2VzLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IpKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBwb2ludCBvZiBwaWVjZS5nZXRQb3NzaWJsZUNhcHR1cmVzKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIU1vdmVVdGlscy53aWxsTW92ZUNhdXNlQ2hlY2soXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLmNvbG9yLFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3csXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LmNvbCxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy55QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy54QXhpcyxcbiAgICAgICAgICAgICAgICAgICAgYm9hcmRcbiAgICAgICAgICAgICAgICApICYmIHBvaW50LmlzRXF1YWwoZGVzdFBvaW50KSkge1xuICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlcy5wdXNoKHBpZWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZm91bmRQaWVjZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmb3JtYXRTaW5nbGUocG9pbnQ6IFBvaW50LCByZXZlcnRlZDogYm9vbGVhbik6IHN0cmluZyB7XG4gICAgICAgIGlmIChyZXZlcnRlZCkge1xuICAgICAgICAgICAgY29uc3Qgc291cmNlWCA9IDEwNCAtIHBvaW50LmNvbDtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShzb3VyY2VYKSArXG4gICAgICAgICAgICAgICAgKHBvaW50LnJvdyArIDEpXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgaW5jcmVtZW50WCA9IDk3O1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKHBvaW50LmNvbCArIGluY3JlbWVudFgpICtcbiAgICAgICAgICAgICAgICAoTWF0aC5hYnMocG9pbnQucm93IC0gNykgKyAxKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0Rmlyc3RMZXR0ZXJQaWVjZShwaWVjZTogUGllY2UpOiBzdHJpbmcge1xuICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBQYXduKSB7XG4gICAgICAgICAgICByZXR1cm4gJ1AnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgS25pZ2h0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdOJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgQmlzaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnQic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUm9vaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdSJztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ0snO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ1EnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBzdGF0aWMgcmV2ZXJzZShib2FyZDogQm9hcmQsIHJvdzogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgPyByb3cgKyAxXG4gICAgICAgICAgICA6IE1hdGguYWJzKHJvdyAtIDcpICsgMTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9ybWF0Q29sKGJvYXJkOiBCb2FyZCwgY29sOiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYm9hcmQucmV2ZXJ0ZWRcbiAgICAgICAgICAgID8gU3RyaW5nLmZyb21DaGFyQ29kZSgxMDQgLSBjb2wpXG4gICAgICAgICAgICA6IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBjb2wpO1xuICAgIH1cbn1cbiJdfQ==