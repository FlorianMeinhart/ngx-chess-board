import { cloneDeep } from 'lodash';
import { Bishop } from './pieces/bishop';
import { Color } from './pieces/color';
import { King } from './pieces/king';
import { Knight } from './pieces/knight';
import { Pawn } from './pieces/pawn';
import { Queen } from './pieces/queen';
import { Rook } from './pieces/rook';
export class Board {
    constructor() {
        this.board = [];
        this.pieces = [];
        this.enPassantPoint = null;
        this.enPassantPiece = null;
        this.lastMoveSrc = null;
        this.lastMoveDest = null;
        this.possibleCaptures = [];
        this.possibleMoves = [];
        this.currentWhitePlayer = true;
        this.reverted = false;
        this.fullMoveCount = 1;
        for (let i = 0; i < 8; ++i) {
            this.board[i] = [];
            for (let j = 0; j < 8; ++j) {
                this.board[i][j] = 0;
            }
        }
    }
    isXYInPossibleMoves(row, col) {
        return this.possibleMoves.some((move) => move.row === row && move.col === col);
    }
    isXYInPossibleCaptures(row, col) {
        return this.possibleCaptures.some((capture) => capture.row === row && capture.col === col);
    }
    isXYInSourceMove(i, j) {
        return this.lastMoveSrc && this.lastMoveSrc.row === i && this.lastMoveSrc.col === j;
    }
    isXYInDestMove(i, j) {
        return this.lastMoveDest && this.lastMoveDest.row === i && this.lastMoveDest.col === j;
    }
    isXYInActiveMove(i, j) {
        return this.activePiece && this.activePiece.point.row === i && this.activePiece.point.col === j;
    }
    isPointInPossibleMoves(point) {
        return this.possibleMoves.some((move) => move.row === point.row && move.col === point.col);
    }
    isPointInPossibleCaptures(point) {
        return this.possibleCaptures.some((capture) => capture.row === point.row && capture.col === point.col);
    }
    reset() {
        this.lastMoveDest = null;
        this.lastMoveSrc = null;
        this.whiteKingChecked = false;
        this.blackKingChecked = false;
        this.possibleCaptures = [];
        this.possibleMoves = [];
        this.activePiece = null;
        this.reverted = false;
        this.currentWhitePlayer = true;
        this.enPassantPoint = null;
        this.enPassantPiece = null;
        this.fullMoveCount = 1;
        this.calculateFEN();
    }
    reverse() {
        this.reverted = !this.reverted;
        this.activePiece = null;
        this.possibleMoves = [];
        this.possibleCaptures = [];
        this.pieces.forEach((piece) => this.reversePoint(piece.point));
        this.reversePoint(this.lastMoveSrc);
        if (this.enPassantPoint && this.enPassantPiece) {
            this.reversePoint(this.enPassantPoint);
        }
    }
    clone() {
        return cloneDeep(this);
    }
    isFieldTakenByEnemy(row, col, enemyColor) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return this.pieces.some((piece) => piece.point.col === col && piece.point.row === row && piece.color === enemyColor);
    }
    isFieldEmpty(row, col) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return !this.pieces.some((piece) => piece.point.col === col && piece.point.row === row);
    }
    isFieldUnderAttack(row, col, color) {
        return this.pieces
            .filter((piece) => piece.color === color)
            .some((piece) => piece.getCoveredFields().some((field) => field.col === col && field.row === row));
    }
    getPieceByField(row, col) {
        if (this.isFieldEmpty(row, col)) {
            //   throw new Error('Piece not found');
            return undefined;
        }
        return this.pieces.find((piece) => piece.point.col === col && piece.point.row === row);
    }
    isKingInCheck(color, pieces) {
        const king = pieces.find((piece) => piece.color === color && piece instanceof King);
        if (king) {
            return pieces.some((piece) => piece
                .getPossibleCaptures()
                .some((point) => point.col === king.point.col && point.row === king.point.row) &&
                piece.color !== color);
        }
        return false;
    }
    getKingByColor(color) {
        return this.pieces.find((piece) => piece instanceof King && piece.color === color);
    }
    getCastleFENString(color) {
        const king = this.getKingByColor(color);
        if (king.isMovedAlready) {
            return '';
        }
        let fen = '';
        const leftRook = this.getPieceByField(king.point.row, 0);
        const rightRook = this.getPieceByField(king.point.row, 7);
        if (rightRook instanceof Rook && rightRook.color === color) {
            if (!rightRook.isMovedAlready) {
                fen += this.reverted ? 'q' : 'k';
            }
        }
        if (leftRook instanceof Rook && leftRook.color === color) {
            if (!leftRook.isMovedAlready) {
                fen += this.reverted ? 'k' : 'q';
            }
        }
        fen = fen.split('').sort().join('');
        return color === Color.BLACK ? fen : fen.toUpperCase();
    }
    getEnPassantFENString() {
        if (this.enPassantPoint) {
            if (this.reverted) {
                return String.fromCharCode(104 - this.enPassantPoint.col) + (this.enPassantPoint.row + 1);
            }
            else {
                return String.fromCharCode(97 + this.enPassantPoint.col) + (Math.abs(this.enPassantPoint.row - 7) + 1);
            }
        }
        else {
            return '-';
        }
    }
    calculateFEN() {
        let fen = '';
        for (let i = 0; i < 8; ++i) {
            let emptyFields = 0;
            for (let j = 0; j < 8; ++j) {
                const foundPiece = this.pieces.find((piece) => piece.point.col === j && piece.point.row === i);
                if (foundPiece) {
                    if (emptyFields > 0) {
                        fen += emptyFields;
                        emptyFields = 0;
                    }
                    if (foundPiece instanceof Rook) {
                        fen += foundPiece.color === Color.BLACK ? 'r' : 'R';
                    }
                    else {
                        if (foundPiece instanceof Knight) {
                            fen += foundPiece.color === Color.BLACK ? 'n' : 'N';
                        }
                        else {
                            if (foundPiece instanceof Bishop) {
                                fen += foundPiece.color === Color.BLACK ? 'b' : 'B';
                            }
                            else {
                                if (foundPiece instanceof Queen) {
                                    fen += foundPiece.color === Color.BLACK ? 'q' : 'Q';
                                }
                                else {
                                    if (foundPiece instanceof King) {
                                        fen += foundPiece.color === Color.BLACK ? 'k' : 'K';
                                    }
                                    else {
                                        if (foundPiece instanceof Pawn) {
                                            fen += foundPiece.color === Color.BLACK ? 'p' : 'P';
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    ++emptyFields;
                }
            }
            if (emptyFields > 0) {
                fen += emptyFields;
            }
            fen += '/';
        }
        fen = fen.substr(0, fen.length - 1);
        if (this.reverted) {
            fen = fen.split('').reverse().join('');
        }
        fen += ' ' + (this.currentWhitePlayer ? 'w' : 'b');
        const whiteEnPassant = this.getCastleFENString(Color.WHITE);
        const blackEnPassant = this.getCastleFENString(Color.BLACK);
        let concatedEnPassant = whiteEnPassant + blackEnPassant;
        if (!concatedEnPassant) {
            concatedEnPassant = '-';
        }
        fen += ' ' + concatedEnPassant;
        fen += ' ' + this.getEnPassantFENString();
        fen += ' ' + 0;
        fen += ' ' + this.fullMoveCount;
        this.fen = fen;
    }
    isXYInPointSelection(i, j) {
        return false;
    }
    reversePoint(point) {
        if (point) {
            point.row = Math.abs(point.row - 7);
            point.col = Math.abs(point.col - 7);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvS29tcHV0ZXIvRGVza3RvcC9Ob3d5IGZvbGRlci9jaGVzcy1ib2FyZC9wcm9qZWN0cy9uZ3gtY2hlc3MtYm9hcmQvc3JjLyIsInNvdXJjZXMiOlsibGliL21vZGVscy9ib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUdyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyQyxNQUFNLE9BQU8sS0FBSztJQW9CZDtRQW5CQSxVQUFLLEdBQWUsRUFBRSxDQUFDO1FBQ3ZCLFdBQU0sR0FBWSxFQUFFLENBQUM7UUFFckIsbUJBQWMsR0FBVSxJQUFJLENBQUM7UUFDN0IsbUJBQWMsR0FBVSxJQUFJLENBQUM7UUFDN0IsZ0JBQVcsR0FBVSxJQUFJLENBQUM7UUFDMUIsaUJBQVksR0FBVSxJQUFJLENBQUM7UUFJM0IscUJBQWdCLEdBQVUsRUFBRSxDQUFDO1FBQzdCLGtCQUFhLEdBQVksRUFBRSxDQUFDO1FBRzVCLHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUMxQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBSWQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFF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QUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUN2QztJQUNMLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBCaXNob3AgfSBmcm9tICcuL3BpZWNlcy9iaXNob3AnO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuL3BpZWNlcy9jb2xvcic7XG5pbXBvcnQgeyBLaW5nIH0gZnJvbSAnLi9waWVjZXMva2luZyc7XG5pbXBvcnQgeyBLbmlnaHQgfSBmcm9tICcuL3BpZWNlcy9rbmlnaHQnO1xuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4vcGllY2VzL3Bhd24nO1xuaW1wb3J0IHsgUGllY2UgfSBmcm9tICcuL3BpZWNlcy9waWVjZSc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4vcGllY2VzL3BvaW50JztcbmltcG9ydCB7IFF1ZWVuIH0gZnJvbSAnLi9waWVjZXMvcXVlZW4nO1xuaW1wb3J0IHsgUm9vayB9IGZyb20gJy4vcGllY2VzL3Jvb2snO1xuXG5leHBvcnQgY2xhc3MgQm9hcmQge1xuICAgIGJvYXJkOiBudW1iZXJbXVtdID0gW107XG4gICAgcGllY2VzOiBQaWVjZVtdID0gW107XG5cbiAgICBlblBhc3NhbnRQb2ludDogUG9pbnQgPSBudWxsO1xuICAgIGVuUGFzc2FudFBpZWNlOiBQaWVjZSA9IG51bGw7XG4gICAgbGFzdE1vdmVTcmM6IFBvaW50ID0gbnVsbDtcbiAgICBsYXN0TW92ZURlc3Q6IFBvaW50ID0gbnVsbDtcbiAgICBhY3RpdmVQaWVjZTogUGllY2U7XG5cbiAgICBibGFja0tpbmdDaGVja2VkOiBib29sZWFuO1xuICAgIHBvc3NpYmxlQ2FwdHVyZXM6IGFueVtdID0gW107XG4gICAgcG9zc2libGVNb3ZlczogUG9pbnRbXSA9IFtdO1xuICAgIHdoaXRlS2luZ0NoZWNrZWQ6IGJvb2xlYW47XG5cbiAgICBjdXJyZW50V2hpdGVQbGF5ZXIgPSB0cnVlO1xuICAgIHJldmVydGVkID0gZmFsc2U7XG4gICAgZnVsbE1vdmVDb3VudCA9IDE7XG4gICAgZmVuOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyArK2kpIHtcbiAgICAgICAgICAgIHRoaXMuYm9hcmRbaV0gPSBbXTtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgODsgKytqKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ib2FyZFtpXVtqXSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1hZSW5Qb3NzaWJsZU1vdmVzKHJvdzogbnVtYmVyLCBjb2w6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3NzaWJsZU1vdmVzLnNvbWUoKG1vdmUpID0+IG1vdmUucm93ID09PSByb3cgJiYgbW92ZS5jb2wgPT09IGNvbCk7XG4gICAgfVxuXG4gICAgaXNYWUluUG9zc2libGVDYXB0dXJlcyhyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zc2libGVDYXB0dXJlcy5zb21lKChjYXB0dXJlKSA9PiBjYXB0dXJlLnJvdyA9PT0gcm93ICYmIGNhcHR1cmUuY29sID09PSBjb2wpO1xuICAgIH1cblxuICAgIGlzWFlJblNvdXJjZU1vdmUoaTogbnVtYmVyLCBqOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdE1vdmVTcmMgJiYgdGhpcy5sYXN0TW92ZVNyYy5yb3cgPT09IGkgJiYgdGhpcy5sYXN0TW92ZVNyYy5jb2wgPT09IGo7XG4gICAgfVxuXG4gICAgaXNYWUluRGVzdE1vdmUoaTogbnVtYmVyLCBqOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdE1vdmVEZXN0ICYmIHRoaXMubGFzdE1vdmVEZXN0LnJvdyA9PT0gaSAmJiB0aGlzLmxhc3RNb3ZlRGVzdC5jb2wgPT09IGo7XG4gICAgfVxuXG4gICAgaXNYWUluQWN0aXZlTW92ZShpOiBudW1iZXIsIGo6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmVQaWVjZSAmJiB0aGlzLmFjdGl2ZVBpZWNlLnBvaW50LnJvdyA9PT0gaSAmJiB0aGlzLmFjdGl2ZVBpZWNlLnBvaW50LmNvbCA9PT0gajtcbiAgICB9XG5cbiAgICBpc1BvaW50SW5Qb3NzaWJsZU1vdmVzKHBvaW50OiBQb2ludCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3NzaWJsZU1vdmVzLnNvbWUoKG1vdmUpID0+IG1vdmUucm93ID09PSBwb2ludC5yb3cgJiYgbW92ZS5jb2wgPT09IHBvaW50LmNvbCk7XG4gICAgfVxuXG4gICAgaXNQb2ludEluUG9zc2libGVDYXB0dXJlcyhwb2ludDogUG9pbnQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zc2libGVDYXB0dXJlcy5zb21lKChjYXB0dXJlKSA9PiBjYXB0dXJlLnJvdyA9PT0gcG9pbnQucm93ICYmIGNhcHR1cmUuY29sID09PSBwb2ludC5jb2wpO1xuICAgIH1cblxuICAgIHJlc2V0KCkge1xuICAgICAgICB0aGlzLmxhc3RNb3ZlRGVzdCA9IG51bGw7XG4gICAgICAgIHRoaXMubGFzdE1vdmVTcmMgPSBudWxsO1xuICAgICAgICB0aGlzLndoaXRlS2luZ0NoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ibGFja0tpbmdDaGVja2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMucG9zc2libGVDYXB0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBvc3NpYmxlTW92ZXMgPSBbXTtcbiAgICAgICAgdGhpcy5hY3RpdmVQaWVjZSA9IG51bGw7XG4gICAgICAgIHRoaXMucmV2ZXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jdXJyZW50V2hpdGVQbGF5ZXIgPSB0cnVlO1xuICAgICAgICB0aGlzLmVuUGFzc2FudFBvaW50ID0gbnVsbDtcbiAgICAgICAgdGhpcy5lblBhc3NhbnRQaWVjZSA9IG51bGw7XG4gICAgICAgIHRoaXMuZnVsbE1vdmVDb3VudCA9IDE7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlRkVOKCk7XG4gICAgfVxuXG4gICAgcmV2ZXJzZSgpIHtcbiAgICAgICAgdGhpcy5yZXZlcnRlZCA9ICF0aGlzLnJldmVydGVkO1xuICAgICAgICB0aGlzLmFjdGl2ZVBpZWNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5wb3NzaWJsZU1vdmVzID0gW107XG4gICAgICAgIHRoaXMucG9zc2libGVDYXB0dXJlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMucGllY2VzLmZvckVhY2goKHBpZWNlOiBQaWVjZSkgPT4gdGhpcy5yZXZlcnNlUG9pbnQocGllY2UucG9pbnQpKTtcblxuICAgICAgICB0aGlzLnJldmVyc2VQb2ludCh0aGlzLmxhc3RNb3ZlU3JjKTtcblxuICAgICAgICBpZiAodGhpcy5lblBhc3NhbnRQb2ludCAmJiB0aGlzLmVuUGFzc2FudFBpZWNlKSB7XG4gICAgICAgICAgICB0aGlzLnJldmVyc2VQb2ludCh0aGlzLmVuUGFzc2FudFBvaW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsb25lKCk6IEJvYXJkIHtcbiAgICAgICAgcmV0dXJuIGNsb25lRGVlcCh0aGlzKTtcbiAgICB9XG5cbiAgICBpc0ZpZWxkVGFrZW5CeUVuZW15KHJvdzogbnVtYmVyLCBjb2w6IG51bWJlciwgZW5lbXlDb2xvcjogQ29sb3IpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHJvdyA+IDcgfHwgcm93IDwgMCB8fCBjb2wgPiA3IHx8IGNvbCA8IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXMuc29tZShcbiAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UucG9pbnQuY29sID09PSBjb2wgJiYgcGllY2UucG9pbnQucm93ID09PSByb3cgJiYgcGllY2UuY29sb3IgPT09IGVuZW15Q29sb3JcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc0ZpZWxkRW1wdHkocm93OiBudW1iZXIsIGNvbDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChyb3cgPiA3IHx8IHJvdyA8IDAgfHwgY29sID4gNyB8fCBjb2wgPCAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICF0aGlzLnBpZWNlcy5zb21lKChwaWVjZSkgPT4gcGllY2UucG9pbnQuY29sID09PSBjb2wgJiYgcGllY2UucG9pbnQucm93ID09PSByb3cpO1xuICAgIH1cblxuICAgIGlzRmllbGRVbmRlckF0dGFjayhyb3c6IG51bWJlciwgY29sOiBudW1iZXIsIGNvbG9yOiBDb2xvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXNcbiAgICAgICAgICAgIC5maWx0ZXIoKHBpZWNlKSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IpXG4gICAgICAgICAgICAuc29tZSgocGllY2UpID0+IHBpZWNlLmdldENvdmVyZWRGaWVsZHMoKS5zb21lKChmaWVsZCkgPT4gZmllbGQuY29sID09PSBjb2wgJiYgZmllbGQucm93ID09PSByb3cpKTtcbiAgICB9XG5cbiAgICBnZXRQaWVjZUJ5RmllbGQocm93OiBudW1iZXIsIGNvbDogbnVtYmVyKTogUGllY2Uge1xuICAgICAgICBpZiAodGhpcy5pc0ZpZWxkRW1wdHkocm93LCBjb2wpKSB7XG4gICAgICAgICAgICAvLyAgIHRocm93IG5ldyBFcnJvcignUGllY2Ugbm90IGZvdW5kJyk7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucGllY2VzLmZpbmQoKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGNvbCAmJiBwaWVjZS5wb2ludC5yb3cgPT09IHJvdyk7XG4gICAgfVxuXG4gICAgaXNLaW5nSW5DaGVjayhjb2xvcjogQ29sb3IsIHBpZWNlczogUGllY2VbXSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBraW5nID0gcGllY2VzLmZpbmQoKHBpZWNlKSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IgJiYgcGllY2UgaW5zdGFuY2VvZiBLaW5nKTtcblxuICAgICAgICBpZiAoa2luZykge1xuICAgICAgICAgICAgcmV0dXJuIHBpZWNlcy5zb21lKFxuICAgICAgICAgICAgICAgIChwaWVjZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgcGllY2VcbiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRQb3NzaWJsZUNhcHR1cmVzKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zb21lKChwb2ludCkgPT4gcG9pbnQuY29sID09PSBraW5nLnBvaW50LmNvbCAmJiBwb2ludC5yb3cgPT09IGtpbmcucG9pbnQucm93KSAmJlxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5jb2xvciAhPT0gY29sb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGdldEtpbmdCeUNvbG9yKGNvbG9yOiBDb2xvcik6IEtpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXMuZmluZCgocGllY2UpID0+IHBpZWNlIGluc3RhbmNlb2YgS2luZyAmJiBwaWVjZS5jb2xvciA9PT0gY29sb3IpIGFzIEtpbmc7XG4gICAgfVxuXG4gICAgZ2V0Q2FzdGxlRkVOU3RyaW5nKGNvbG9yOiBDb2xvcikge1xuICAgICAgICBjb25zdCBraW5nID0gdGhpcy5nZXRLaW5nQnlDb2xvcihjb2xvcik7XG5cbiAgICAgICAgaWYgKGtpbmcuaXNNb3ZlZEFscmVhZHkpIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmZW4gPSAnJztcbiAgICAgICAgY29uc3QgbGVmdFJvb2sgPSB0aGlzLmdldFBpZWNlQnlGaWVsZChraW5nLnBvaW50LnJvdywgMCk7XG4gICAgICAgIGNvbnN0IHJpZ2h0Um9vayA9IHRoaXMuZ2V0UGllY2VCeUZpZWxkKGtpbmcucG9pbnQucm93LCA3KTtcblxuICAgICAgICBpZiAocmlnaHRSb29rIGluc3RhbmNlb2YgUm9vayAmJiByaWdodFJvb2suY29sb3IgPT09IGNvbG9yKSB7XG4gICAgICAgICAgICBpZiAoIXJpZ2h0Um9vay5pc01vdmVkQWxyZWFkeSkge1xuICAgICAgICAgICAgICAgIGZlbiArPSB0aGlzLnJldmVydGVkID8gJ3EnIDogJ2snO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxlZnRSb29rIGluc3RhbmNlb2YgUm9vayAmJiBsZWZ0Um9vay5jb2xvciA9PT0gY29sb3IpIHtcbiAgICAgICAgICAgIGlmICghbGVmdFJvb2suaXNNb3ZlZEFscmVhZHkpIHtcbiAgICAgICAgICAgICAgICBmZW4gKz0gdGhpcy5yZXZlcnRlZCA/ICdrJyA6ICdxJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZlbiA9IGZlbi5zcGxpdCgnJykuc29ydCgpLmpvaW4oJycpO1xuICAgICAgICByZXR1cm4gY29sb3IgPT09IENvbG9yLkJMQUNLID8gZmVuIDogZmVuLnRvVXBwZXJDYXNlKCk7XG4gICAgfVxuXG4gICAgZ2V0RW5QYXNzYW50RkVOU3RyaW5nKCkge1xuICAgICAgICBpZiAodGhpcy5lblBhc3NhbnRQb2ludCkge1xuICAgICAgICAgICAgaWYgKHRoaXMucmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSgxMDQgLSB0aGlzLmVuUGFzc2FudFBvaW50LmNvbCkgKyAodGhpcy5lblBhc3NhbnRQb2ludC5yb3cgKyAxKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyB0aGlzLmVuUGFzc2FudFBvaW50LmNvbCkgKyAoTWF0aC5hYnModGhpcy5lblBhc3NhbnRQb2ludC5yb3cgLSA3KSArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICctJztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNhbGN1bGF0ZUZFTigpIHtcbiAgICAgICAgbGV0IGZlbiA9ICcnO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xuICAgICAgICAgICAgbGV0IGVtcHR5RmllbGRzID0gMDtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgODsgKytqKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZm91bmRQaWVjZSA9IHRoaXMucGllY2VzLmZpbmQoKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGogJiYgcGllY2UucG9pbnQucm93ID09PSBpKTtcbiAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZW1wdHlGaWVsZHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz0gZW1wdHlGaWVsZHM7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbXB0eUZpZWxkcyA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIFJvb2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPSBmb3VuZFBpZWNlLmNvbG9yID09PSBDb2xvci5CTEFDSyA/ICdyJyA6ICdSJztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgS25pZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLID8gJ24nIDogJ04nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIEJpc2hvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz0gZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0sgPyAnYicgOiAnQic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLID8gJ3EnIDogJ1EnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLID8gJ2snIDogJ0snO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIFBhd24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLID8gJ3AnIDogJ1AnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICsrZW1wdHlGaWVsZHM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZW1wdHlGaWVsZHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgZmVuICs9IGVtcHR5RmllbGRzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZW4gKz0gJy8nO1xuICAgICAgICB9XG5cbiAgICAgICAgZmVuID0gZmVuLnN1YnN0cigwLCBmZW4ubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgaWYgKHRoaXMucmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGZlbiA9IGZlbi5zcGxpdCgnJykucmV2ZXJzZSgpLmpvaW4oJycpO1xuICAgICAgICB9XG5cbiAgICAgICAgZmVuICs9ICcgJyArICh0aGlzLmN1cnJlbnRXaGl0ZVBsYXllciA/ICd3JyA6ICdiJyk7XG4gICAgICAgIGNvbnN0IHdoaXRlRW5QYXNzYW50ID0gdGhpcy5nZXRDYXN0bGVGRU5TdHJpbmcoQ29sb3IuV0hJVEUpO1xuICAgICAgICBjb25zdCBibGFja0VuUGFzc2FudCA9IHRoaXMuZ2V0Q2FzdGxlRkVOU3RyaW5nKENvbG9yLkJMQUNLKTtcbiAgICAgICAgbGV0IGNvbmNhdGVkRW5QYXNzYW50ID0gd2hpdGVFblBhc3NhbnQgKyBibGFja0VuUGFzc2FudDtcbiAgICAgICAgaWYgKCFjb25jYXRlZEVuUGFzc2FudCkge1xuICAgICAgICAgICAgY29uY2F0ZWRFblBhc3NhbnQgPSAnLSc7XG4gICAgICAgIH1cblxuICAgICAgICBmZW4gKz0gJyAnICsgY29uY2F0ZWRFblBhc3NhbnQ7XG4gICAgICAgIGZlbiArPSAnICcgKyB0aGlzLmdldEVuUGFzc2FudEZFTlN0cmluZygpO1xuICAgICAgICBmZW4gKz0gJyAnICsgMDtcbiAgICAgICAgZmVuICs9ICcgJyArIHRoaXMuZnVsbE1vdmVDb3VudDtcbiAgICAgICAgdGhpcy5mZW4gPSBmZW47XG4gICAgfVxuXG4gICAgaXNYWUluUG9pbnRTZWxlY3Rpb24oaTogbnVtYmVyLCBqOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmV2ZXJzZVBvaW50KHBvaW50OiBQb2ludCkge1xuICAgICAgICBpZiAocG9pbnQpIHtcbiAgICAgICAgICAgIHBvaW50LnJvdyA9IE1hdGguYWJzKHBvaW50LnJvdyAtIDcpO1xuICAgICAgICAgICAgcG9pbnQuY29sID0gTWF0aC5hYnMocG9pbnQuY29sIC0gNyk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=