import { Bishop } from '../../../../../models/pieces/bishop';
import { Color } from '../../../../../models/pieces/color';
import { King } from '../../../../../models/pieces/king';
import { Knight } from '../../../../../models/pieces/knight';
import { Pawn } from '../../../../../models/pieces/pawn';
import { Point } from '../../../../../models/pieces/point';
import { Queen } from '../../../../../models/pieces/queen';
import { Rook } from '../../../../../models/pieces/rook';
import { MoveUtils } from '../../../../../utils/move-utils';
import { DefaultPiecesLoader } from '../../default-pieces-loader';
export class DefaultPgnProcessor {
    process(notation, engineFacade) {
        if (notation) {
            engineFacade.board.reverted = false;
            engineFacade.board.pieces = [];
            engineFacade.reset();
            DefaultPiecesLoader.loadDefaultPieces(engineFacade.board);
            let moves = this.extractMoves(notation);
            let counter = -1;
            for (let move of moves) {
                ++counter;
                move = move.replace(/[+#]/g, '');
                let promotionIndex = '';
                if (move.includes('=')) {
                    promotionIndex = this.resolvePromotion(move.substring(move.length - 1));
                    move = move.substring(0, move.length - 2);
                }
                let color = (counter === 0 || counter % 2 === 0)
                    ? Color.WHITE
                    : Color.BLACK;
                if (/^[a-z]\d$/g.test(move)) { // zwykly ruch na wolne pole e4
                    let piece = MoveUtils.findPieceByPossibleMovesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    // en passant check
                    if (!piece) {
                        piece = MoveUtils.findPieceByPossibleCapturesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    }
                    // if piece is found for sure
                    if (piece) {
                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move + promotionIndex);
                    }
                }
                else {
                    if (/^[A-Z][a-h]\d$/g.test(move)) { // jezeli ma wielka litere, czyli trzeba odszukac ktora figura Nf3
                        let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(1), engineFacade.board, color);
                        let piece = pieces.find(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                        if (piece) {
                            engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(1) + promotionIndex);
                        }
                        else {
                        }
                    }
                    else {
                        if ('O-O' === move) {
                            engineFacade.move(color === Color.WHITE ? 'e1g1' : 'e8g8');
                        }
                        else {
                            if (/^[a-z]x[a-z]\d$/g.test(move)) { //exd5
                                let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => piece instanceof Pawn);
                                let piece;
                                if (pieces.length > 1) {
                                    piece = this.resolveByCol(pieces, move.substring(0, 1));
                                }
                                else {
                                    piece = pieces[0];
                                }
                                if (piece) {
                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                }
                                else {
                                }
                            }
                            else {
                                if (/^[A-Z]x[a-z]\d$/g.test(move)) {
                                    let piece = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).find(piece => this.resolvePieceByFirstChar(move.substring(0, 1), piece));
                                    if (piece) {
                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                    }
                                    else {
                                    }
                                }
                                else {
                                    if (move === 'O-O-O') {
                                        engineFacade.move(color === Color.WHITE ? 'e1c1' : 'e8c8');
                                    }
                                    else {
                                        if (/^[A-Z]\dx[a-z]\d$/g.test(move)) { //Ngxe4 sytuacja 2 skoczkow pion bicie
                                            let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                            let piece = this.resolveByRow(pieces, move.substring(1, 2));
                                            if (piece) {
                                                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                            }
                                        }
                                        else {
                                            if (/^[A-Z][a-z][a-z]\d$/g.test(move)) { // dwie wieze bez bicia Rac1 pion
                                                let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                if (piece) {
                                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
                                                }
                                            }
                                            else {
                                                if (/^[A-Z][a-z]x[a-z]\d$/g.test(move)) {
                                                    let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                    let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                    if (piece) {
                                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                                    }
                                                }
                                                else {
                                                    this.processR1f2(move, engineFacade, color, promotionIndex);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    processR1f2(move, engineFacade, color, promotionIndex) {
        if (/^[A-Z]\d[a-z]\d$/g.test(move)) { // R1f2
            let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
            let piece = this.resolveByRow(pieces, move.substring(1, 2));
            if (piece) {
                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
            }
        }
    }
    extractMoves(notation) {
        return notation.substring(notation.lastIndexOf(']') + 1)
            .replace(/[0-9]+\./g, '')
            .replace(/\s+/g, ' ')
            .replace(/{[^}]*}/g, '')
            .trim()
            .split(' ')
            .filter(s => s);
    }
    movePiece(piece, board, move) {
        let indexes = MoveUtils.translateCoordsToIndex(move, board.reverted);
        piece.point.col = indexes.xAxis;
        piece.point.row = indexes.yAxis;
    }
    hasUpperCase(move) {
        return /[A-Z]/.test(move);
    }
    resolvePieceByFirstChar(move, piece) {
        let piecesFirstChar = '';
        if (piece instanceof King) {
            piecesFirstChar = 'K';
        }
        else {
            if (piece instanceof Queen) {
                piecesFirstChar = 'Q';
            }
            else {
                if (piece instanceof Rook) {
                    piecesFirstChar = 'R';
                }
                else {
                    if (piece instanceof Bishop) {
                        piecesFirstChar = 'B';
                    }
                    else {
                        if (piece instanceof Knight) {
                            piecesFirstChar = 'N';
                        }
                        else {
                            if (piece instanceof Pawn) {
                                piecesFirstChar = 'P';
                            }
                        }
                    }
                }
            }
        }
        return move === piecesFirstChar;
    }
    isShortCastle(move) {
        return move === 'O-O';
    }
    removePiece(coords, board) {
        let indexes = MoveUtils.translateCoordsToIndex(coords, board.reverted);
        board.pieces = board.pieces.filter(e => !e.point.isEqual(new Point(indexes.yAxis, indexes.xAxis)));
    }
    isLongCastle(move) {
        return move === 'O-O-O';
    }
    resolveByCol(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(0, 1) === char
            ? pieces[0]
            : pieces[1];
    }
    resolveByRow(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(1, 2) === char
            ? pieces[0]
            : pieces[1];
    }
    replacePromotion(move) {
        return move
            .replace('=Q', '1')
            .replace('=R', '2')
            .replace('=B', '3')
            .replace('=K', '4');
    }
    resolvePromotion(promotionChar) {
        switch (promotionChar) {
            case 'Q':
                return '1';
            case 'R':
                return '2';
            case 'B':
                return '3';
            case 'N':
                return '4';
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL0tvbXB1dGVyL0Rlc2t0b3AvTm93eSBmb2xkZXIvY2hlc3MtYm9hcmQvcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9lbmdpbmUvYm9hcmQtc3RhdGUtcHJvdmlkZXIvYm9hcmQtbG9hZGVyL25vdGF0aW9uLXByb2Nlc3NvcnMvcGduLWxvYWRlci9kZWZhdWx0LXBnbi1wcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQzdELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQzdELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUV6RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0QsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzNELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFNUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFHbEUsTUFBTSxPQUFPLG1CQUFtQjtJQUVyQixPQUFPLENBQUMsUUFBZ0IsRUFBRSxZQUFrQztRQUMvRCxJQUFJLFFBQVEsRUFBRTtZQUNWLFlBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztZQUNwQyxZQUFZLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDL0IsWUFBWSxDQUFDLEtBQUss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RSxDQUFDLENBQUMsS0FBSyxJQUFJO1lBQzVDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsSUFBWTtRQUNqQyxPQUFPLElBQUk7YUFDTixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQzthQUNsQixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQzthQUNsQixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQzthQUNsQixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxhQUFxQjtRQUMxQyxRQUFRLGFBQWEsRUFBRTtZQUNuQixLQUFLLEdBQUc7Z0JBQ0osT0FBTyxHQUFHLENBQUM7WUFDZixLQUFLLEdBQUc7Z0JBQ0osT0FBTyxHQUFHLENBQUM7WUFDZixLQUFLLEdBQUc7Z0JBQ0osT0FBTyxHQUFHLENBQUM7WUFDZixLQUFLLEdBQUc7Z0JBQ0osT0FBTyxHQUFHLENBQUM7U0FDbEI7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvYXJkIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL2JvYXJkJztcbmltcG9ydCB7IEJpc2hvcCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvYmlzaG9wJztcbmltcG9ydCB7IENvbG9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9jb2xvcic7XG5pbXBvcnQgeyBLaW5nIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9raW5nJztcbmltcG9ydCB7IEtuaWdodCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMva25pZ2h0JztcbmltcG9ydCB7IFBhd24gfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3Bhd24nO1xuaW1wb3J0IHsgUGllY2UgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3BpZWNlJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9wb2ludCc7XG5pbXBvcnQgeyBRdWVlbiB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcXVlZW4nO1xuaW1wb3J0IHsgUm9vayB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcm9vayc7XG5pbXBvcnQgeyBNb3ZlVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi91dGlscy9tb3ZlLXV0aWxzJztcbmltcG9ydCB7IEFic3RyYWN0RW5naW5lRmFjYWRlIH0gZnJvbSAnLi4vLi4vLi4vLi4vYWJzdHJhY3QtZW5naW5lLWZhY2FkZSc7XG5pbXBvcnQgeyBEZWZhdWx0UGllY2VzTG9hZGVyIH0gZnJvbSAnLi4vLi4vZGVmYXVsdC1waWVjZXMtbG9hZGVyJztcbmltcG9ydCB7IE5vdGF0aW9uUHJvY2Vzc29yIH0gZnJvbSAnLi4vbm90YXRpb24tcHJvY2Vzc29yJztcblxuZXhwb3J0IGNsYXNzIERlZmF1bHRQZ25Qcm9jZXNzb3IgaW1wbGVtZW50cyBOb3RhdGlvblByb2Nlc3NvciB7XG5cbiAgICBwdWJsaWMgcHJvY2Vzcyhub3RhdGlvbjogc3RyaW5nLCBlbmdpbmVGYWNhZGU6IEFic3RyYWN0RW5naW5lRmFjYWRlKTogdm9pZCB7XG4gICAgICAgIGlmIChub3RhdGlvbikge1xuICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLnJldmVydGVkID0gZmFsc2U7XG4gICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQucGllY2VzID0gW107XG4gICAgICAgICAgICBlbmdpbmVGYWNhZGUucmVzZXQoKTtcbiAgICAgICAgICAgIERlZmF1bHRQaWVjZXNMb2FkZXIubG9hZERlZmF1bHRQaWVjZXMoZW5naW5lRmFjYWRlLmJvYXJkKTtcbiAgICAgICAgICAgIGxldCBtb3ZlcyA9IHRoaXMuZXh0cmFjdE1vdmVzKG5vdGF0aW9uKTtcbiAgICAgICAgICAgIGxldCBjb3VudGVyID0gLTE7XG4gICAgICAgICAgICBmb3IgKGxldCBtb3ZlIG9mIG1vdmVzKSB7XG4gICAgICAgICAgICAgICAgKytjb3VudGVyO1xuICAgICAgICAgICAgICAgIG1vdmUgPSBtb3ZlLnJlcGxhY2UoL1srI10vZywgJycpO1xuICAgICAgICAgICAgICAgIGxldCBwcm9tb3Rpb25JbmRleCA9ICcnO1xuXG4gICAgICAgICAgICAgICAgaWYgKG1vdmUuaW5jbHVkZXMoJz0nKSkge1xuICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCA9IHRoaXMucmVzb2x2ZVByb21vdGlvbihtb3ZlLnN1YnN0cmluZyhtb3ZlLmxlbmd0aCAtIDEpKTtcbiAgICAgICAgICAgICAgICAgICAgbW92ZSA9IG1vdmUuc3Vic3RyaW5nKDAsIG1vdmUubGVuZ3RoIC0gMik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gKGNvdW50ZXIgPT09IDAgfHwgY291bnRlciAlIDIgPT09IDApXG4gICAgICAgICAgICAgICAgICAgID8gQ29sb3IuV0hJVEVcbiAgICAgICAgICAgICAgICAgICAgOiBDb2xvci5CTEFDSztcblxuICAgICAgICAgICAgICAgIGlmICgvXlthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgLy8gend5a2x5IHJ1Y2ggbmEgd29sbmUgcG9sZSBlNFxuICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgICAgICAgICApLmZpbmQocGllY2UgPT4gcGllY2UgaW5zdGFuY2VvZiBQYXduKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBlbiBwYXNzYW50IGNoZWNrXG4gICAgICAgICAgICAgICAgICAgIGlmICghcGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSwgZW5naW5lRmFjYWRlLmJvYXJkLCBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgKS5maW5kKHBpZWNlID0+IHBpZWNlIGluc3RhbmNlb2YgUGF3bik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBpZiBwaWVjZSBpcyBmb3VuZCBmb3Igc3VyZVxuICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS1oXVxcZCQvZy50ZXN0KG1vdmUpKSB7Ly8gamV6ZWxpIG1hIHdpZWxrYSBsaXRlcmUsIGN6eWxpIHRyemViYSBvZHN6dWthYyBrdG9yYSBmaWd1cmEgTmYzXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gcGllY2VzLmZpbmQocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZVxuICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoMSkgKyBwcm9tb3Rpb25JbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCdPLU8nID09PSBtb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoY29sb3IgPT09IENvbG9yLldISVRFID8gJ2UxZzEnIDogJ2U4ZzgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW2Etel14W2Etel1cXGQkL2cudGVzdChtb3ZlKSkgeyAvL2V4ZDVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHBpZWNlIGluc3RhbmNlb2YgUGF3bik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2VzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDAsIDEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UgPSBwaWVjZXNbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoJ3gnKSArIDEpICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl14W2Etel1cXGQkL2cudGVzdChtb3ZlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmluZChwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDAsIDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoJ3gnKSArIDEpICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3ZlID09PSAnTy1PLU8nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoY29sb3IgPT09IENvbG9yLldISVRFID8gJ2UxYzEnIDogJ2U4YzgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1cXGR4W2Etel1cXGQkL2cudGVzdChtb3ZlKSkgeyAgLy9OZ3hlNCBzeXR1YWNqYSAyIHNrb2N6a293IHBpb24gYmljaWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Um93KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSwgMilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gnKSArIDEpICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS16XVthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgLy8gZHdpZSB3aWV6ZSBiZXogYmljaWEgUmFjMSBwaW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMiwgNCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS16XXhbYS16XVxcZCQvZy50ZXN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneCcpICsgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuaW5kZXhPZihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneCcpICsgMSkgKyBwcm9tb3Rpb25JbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NSMWYyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NSMWYyKG1vdmUsIGVuZ2luZUZhY2FkZSwgY29sb3IsIHByb21vdGlvbkluZGV4KSB7XG4gICAgICAgIGlmICgvXltBLVpdXFxkW2Etel1cXGQkL2cudGVzdChtb3ZlKSkgeyAvLyBSMWYyXG4gICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMiwgNCksXG4gICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxuICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICApKTtcblxuICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlSb3coXG4gICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgIDIsXG4gICAgICAgICAgICAgICAgICAgIDRcbiAgICAgICAgICAgICAgICApICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGV4dHJhY3RNb3Zlcyhub3RhdGlvbjogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBub3RhdGlvbi5zdWJzdHJpbmcobm90YXRpb24ubGFzdEluZGV4T2YoJ10nKSArIDEpXG4gICAgICAgICAgICAucmVwbGFjZSgvWzAtOV0rXFwuL2csICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xccysvZywgJyAnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL3tbXn1dKn0vZywgJycpXG4gICAgICAgICAgICAudHJpbSgpXG4gICAgICAgICAgICAuc3BsaXQoJyAnKVxuICAgICAgICAgICAgLmZpbHRlcihzID0+IHMpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBtb3ZlUGllY2UocGllY2U6IFBpZWNlLCBib2FyZDogQm9hcmQsIG1vdmU6IHN0cmluZykge1xuICAgICAgICBsZXQgaW5kZXhlcyA9IE1vdmVVdGlscy50cmFuc2xhdGVDb29yZHNUb0luZGV4KG1vdmUsIGJvYXJkLnJldmVydGVkKTtcbiAgICAgICAgcGllY2UucG9pbnQuY29sID0gaW5kZXhlcy54QXhpcztcbiAgICAgICAgcGllY2UucG9pbnQucm93ID0gaW5kZXhlcy55QXhpcztcbiAgICB9XG5cbiAgICBoYXNVcHBlckNhc2UobW92ZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiAvW0EtWl0vLnRlc3QobW92ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihtb3ZlOiBzdHJpbmcsIHBpZWNlOiBQaWVjZSkge1xuICAgICAgICBsZXQgcGllY2VzRmlyc3RDaGFyID0gJyc7XG4gICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcbiAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdLJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFF1ZWVuKSB7XG4gICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ1EnO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBSb29rKSB7XG4gICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdSJztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBCaXNob3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdCJztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtuaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdOJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUGF3bikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnUCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtb3ZlID09PSBwaWVjZXNGaXJzdENoYXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1Nob3J0Q2FzdGxlKG1vdmU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbW92ZSA9PT0gJ08tTyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVQaWVjZShjb29yZHM6IHN0cmluZywgYm9hcmQ6IEJvYXJkKSB7XG4gICAgICAgIGxldCBpbmRleGVzID0gTW92ZVV0aWxzLnRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgoY29vcmRzLCBib2FyZC5yZXZlcnRlZCk7XG5cbiAgICAgICAgYm9hcmQucGllY2VzID0gYm9hcmQucGllY2VzLmZpbHRlcihlID0+ICFlLnBvaW50LmlzRXF1YWwobmV3IFBvaW50KFxuICAgICAgICAgICAgaW5kZXhlcy55QXhpcyxcbiAgICAgICAgICAgIGluZGV4ZXMueEF4aXNcbiAgICAgICAgKSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNMb25nQ2FzdGxlKG1vdmU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbW92ZSA9PT0gJ08tTy1PJztcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc29sdmVCeUNvbChwaWVjZXM6IFBpZWNlW10sIGNoYXI6IHN0cmluZyk6IFBpZWNlIHtcbiAgICAgICAgbGV0IGZpcnN0UGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1swXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gZmlyc3RQaWVjZUZvcm1hdC5zdWJzdHJpbmcoMCwgMSkgPT09IGNoYXJcbiAgICAgICAgICAgID8gcGllY2VzWzBdXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc29sdmVCeVJvdyhwaWVjZXM6IFBpZWNlW10sIGNoYXI6IHN0cmluZykge1xuICAgICAgICBsZXQgZmlyc3RQaWVjZUZvcm1hdCA9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2VzWzBdLnBvaW50LCBmYWxzZSk7XG4gICAgICAgIGxldCBzZWNvbmRQaWVjZUZvcm1hdCA9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2VzWzFdLnBvaW50LCBmYWxzZSk7XG4gICAgICAgIHJldHVybiBmaXJzdFBpZWNlRm9ybWF0LnN1YnN0cmluZygxLCAyKSA9PT0gY2hhclxuICAgICAgICAgICAgPyBwaWVjZXNbMF1cbiAgICAgICAgICAgIDogcGllY2VzWzFdO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVwbGFjZVByb21vdGlvbihtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmVcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9UScsICcxJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9UicsICcyJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9QicsICczJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9SycsICc0Jyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlUHJvbW90aW9uKHByb21vdGlvbkNoYXI6IHN0cmluZykge1xuICAgICAgICBzd2l0Y2ggKHByb21vdGlvbkNoYXIpIHtcbiAgICAgICAgICAgIGNhc2UgJ1EnOlxuICAgICAgICAgICAgICAgIHJldHVybiAnMSc7XG4gICAgICAgICAgICBjYXNlICdSJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzInO1xuICAgICAgICAgICAgY2FzZSAnQic6XG4gICAgICAgICAgICAgICAgcmV0dXJuICczJztcbiAgICAgICAgICAgIGNhc2UgJ04nOlxuICAgICAgICAgICAgICAgIHJldHVybiAnNCc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cbn1cbiJdfQ==