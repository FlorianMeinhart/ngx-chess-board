import { King } from '../../models/pieces/king';
import { Pawn } from '../../models/pieces/pawn';
import { MoveUtils } from '../../utils/move-utils';
import { AbstractPgnProcessor } from './abstract-pgn-processor';
export class DefaultPgnProcessor extends AbstractPgnProcessor {
    process(board, sourcePiece, destPoint, destPiece) {
        this.currentIndex += 0.5;
        this.pgn += (this.currentIndex % Math.floor(this.currentIndex) === 0) ? (' ' + this.currentIndex + '. ') : ' ';
        let possibleCaptures = [];
        let possibleMoves = [];
        if (destPiece) {
            possibleCaptures = MoveUtils.findPieceByPossibleCapturesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        }
        possibleMoves = MoveUtils.findPieceByPossibleMovesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        if (sourcePiece instanceof Pawn && !destPiece && possibleCaptures.length === 0) {
            this.pgn += MoveUtils.formatSingle(destPoint, board.reverted);
        }
        else {
            if (sourcePiece instanceof Pawn && destPiece) {
                this.pgn += MoveUtils.formatSingle(sourcePiece.point, board.reverted).substring(0, 1) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
            }
            else {
                if (sourcePiece instanceof King && (Math.abs(sourcePiece.point.col - destPoint.col) === 2)) {
                    if (board.reverted) {
                        this.pgn += destPoint.col < 2
                            ? 'O-O'
                            : 'O-O-O';
                    }
                    else {
                        this.pgn += destPoint.col < 3
                            ? 'O-O-O'
                            : 'O-O';
                    }
                }
                else {
                    if (!(sourcePiece instanceof Pawn) && possibleCaptures.length === 0 && possibleMoves.length < 2) { // Nf3
                        this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatSingle(destPoint, board.reverted);
                    }
                    else {
                        if (possibleMoves && possibleMoves.length === 2 && possibleCaptures.length === 0) { // Nbd7
                            if (this.isEqualByCol(possibleMoves[0], possibleMoves[1])) {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                        else {
                            if (possibleCaptures.length > 1) {
                                if ((this.isEqualByCol(possibleCaptures[0], possibleCaptures[1]))) {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                                else {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                    }
                }
            }
        }
        this.pgn = this.pgn.trim();
    }
    resolvePieceByFirstChar(move, piece) {
        return MoveUtils.getFirstLetterPiece(piece) === move;
    }
    isEqualByCol(aPiece, bPiece) {
        return aPiece.point.col === bPiece.point.col;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL0tvbXB1dGVyL0Rlc2t0b3AvTm93eSBmb2xkZXIvY2hlc3MtYm9hcmQvcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9lbmdpbmUvcGduL2RlZmF1bHQtcGduLXByb2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBR2hELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVoRSxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsb0JBQW9CO0lBRWxELE9BQU8sQ0FDVixLQUFZLEVBQ1osV0FBa0IsRUFDbEIsU0FBZ0IsRUFDaEIsU0FBaUI7UUFFakIsSUFBSSxDQUFDLFlBQVksSUFBSSxHQUFHLENBQUM7UUFDekIsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUUvRyxJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFFdkIsSUFBSSxTQUFTLEVBQUU7WUFDWCxnQkFBZ0IsR0FBRyxTQUFTLENBQUMscUNBQXFDLENBQzlELFNBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFDakQsS0FBSyxFQUNM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QUM7NkJBQ0w7eUJBQ0o7cUJBQ0o7aUJBQ0o7YUFDSjtTQUNKO1FBRUQsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxJQUFZLEVBQUUsS0FBWTtRQUN0RCxPQUFPLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLENBQUM7SUFDekQsQ0FBQztJQUVPLFlBQVksQ0FBQyxNQUFhLEVBQUUsTUFBYTtRQUM3QyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ2pELENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvYXJkIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2JvYXJkJztcclxuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMva2luZyc7XHJcbmltcG9ydCB7IFBhd24gfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL3Bhd24nO1xyXG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcGllY2UnO1xyXG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcG9pbnQnO1xyXG5pbXBvcnQgeyBNb3ZlVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscy9tb3ZlLXV0aWxzJztcclxuaW1wb3J0IHsgQWJzdHJhY3RQZ25Qcm9jZXNzb3IgfSBmcm9tICcuL2Fic3RyYWN0LXBnbi1wcm9jZXNzb3InO1xyXG5cclxuZXhwb3J0IGNsYXNzIERlZmF1bHRQZ25Qcm9jZXNzb3IgZXh0ZW5kcyBBYnN0cmFjdFBnblByb2Nlc3NvciB7XHJcblxyXG4gICAgcHVibGljIHByb2Nlc3MoXHJcbiAgICAgICAgYm9hcmQ6IEJvYXJkLFxyXG4gICAgICAgIHNvdXJjZVBpZWNlOiBQaWVjZSxcclxuICAgICAgICBkZXN0UG9pbnQ6IFBvaW50LFxyXG4gICAgICAgIGRlc3RQaWVjZT86IFBpZWNlXHJcbiAgICApOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmN1cnJlbnRJbmRleCArPSAwLjU7XHJcbiAgICAgICAgdGhpcy5wZ24gKz0gKHRoaXMuY3VycmVudEluZGV4ICUgTWF0aC5mbG9vcih0aGlzLmN1cnJlbnRJbmRleCkgPT09IDApID8gKCcgJyArIHRoaXMuY3VycmVudEluZGV4ICsgJy4gJykgOiAnICc7XHJcblxyXG4gICAgICAgIGxldCBwb3NzaWJsZUNhcHR1cmVzID0gW107XHJcbiAgICAgICAgbGV0IHBvc3NpYmxlTW92ZXMgPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKGRlc3RQaWVjZSkge1xyXG4gICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXHJcbiAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpLFxyXG4gICAgICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5jb2xvclxyXG4gICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBzb3VyY2VQaWVjZS5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcG9zc2libGVNb3ZlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxyXG4gICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpLFxyXG4gICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgc291cmNlUGllY2UuY29sb3JcclxuICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBzb3VyY2VQaWVjZS5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuXHJcbiAgICAgICAgaWYgKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgUGF3biAmJiAhZGVzdFBpZWNlICYmIHBvc3NpYmxlQ2FwdHVyZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgUGF3biAmJiBkZXN0UGllY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICkuc3Vic3RyaW5nKDAsIDEpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlUGllY2UgaW5zdGFuY2VvZiBLaW5nICYmIChNYXRoLmFicyhzb3VyY2VQaWVjZS5wb2ludC5jb2wgLSBkZXN0UG9pbnQuY29sKSA9PT0gMikpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYm9hcmQucmV2ZXJ0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gZGVzdFBvaW50LmNvbCA8IDJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ08tTydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ08tTy1PJztcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBkZXN0UG9pbnQuY29sIDwgM1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnTy1PLU8nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdPLU8nO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEoc291cmNlUGllY2UgaW5zdGFuY2VvZiBQYXduKSAmJiBwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA9PT0gMCAmJiBwb3NzaWJsZU1vdmVzLmxlbmd0aCA8IDIpIHsgICAgIC8vIE5mM1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zc2libGVNb3ZlcyAmJiBwb3NzaWJsZU1vdmVzLmxlbmd0aCA9PT0gMiAmJiBwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA9PT0gMCkgeyAgICAvLyBOYmQ3XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0VxdWFsQnlDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1swXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZU1vdmVzWzFdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5yZXZlcnNlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLmZvcm1hdENvbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuaXNFcXVhbEJ5Q29sKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzWzFdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMucmV2ZXJzZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyAneCcgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucGduID0gdGhpcy5wZ24udHJpbSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIobW92ZTogc3RyaW5nLCBwaWVjZTogUGllY2UpIHtcclxuICAgICAgICByZXR1cm4gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UocGllY2UpID09PSBtb3ZlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNFcXVhbEJ5Q29sKGFQaWVjZTogUGllY2UsIGJQaWVjZTogUGllY2UpIHtcclxuICAgICAgICByZXR1cm4gYVBpZWNlLnBvaW50LmNvbCA9PT0gYlBpZWNlLnBvaW50LmNvbDtcclxuICAgIH1cclxuXHJcbn1cclxuIl19