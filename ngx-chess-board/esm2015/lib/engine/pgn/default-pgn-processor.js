import { King } from '../../models/pieces/king';
import { Pawn } from '../../models/pieces/pawn';
import { MoveUtils } from '../../utils/move-utils';
import { AbstractPgnProcessor } from './abstract-pgn-processor';
export class DefaultPgnProcessor extends AbstractPgnProcessor {
    process(board, sourcePiece, destPoint, destPiece) {
        this.currentIndex += 0.5;
        this.pgn += (this.currentIndex % Math.floor(this.currentIndex) === 0) ? (' ' + this.currentIndex + '. ') : ' ';
        let possibleCaptures = [];
        let possibleMoves = [];
        if (destPiece) {
            possibleCaptures = MoveUtils.findPieceByPossibleCapturesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        }
        possibleMoves = MoveUtils.findPieceByPossibleMovesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        if (sourcePiece instanceof Pawn && !destPiece && possibleCaptures.length === 0) {
            this.pgn += MoveUtils.formatSingle(destPoint, board.reverted);
        }
        else {
            if (sourcePiece instanceof Pawn && destPiece) {
                this.pgn += MoveUtils.formatSingle(sourcePiece.point, board.reverted).substring(0, 1) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
            }
            else {
                if (sourcePiece instanceof King && (Math.abs(sourcePiece.point.col - destPoint.col) === 2)) {
                    if (board.reverted) {
                        this.pgn += destPoint.col < 2
                            ? 'O-O'
                            : 'O-O-O';
                    }
                    else {
                        this.pgn += destPoint.col < 3
                            ? 'O-O-O'
                            : 'O-O';
                    }
                }
                else {
                    if (!(sourcePiece instanceof Pawn) && possibleCaptures.length === 0 && possibleMoves.length < 2) { // Nf3
                        this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatSingle(destPoint, board.reverted);
                    }
                    else {
                        if (possibleMoves && possibleMoves.length === 2 && possibleCaptures.length === 0) { // Nbd7
                            if (this.isEqualByCol(possibleMoves[0], possibleMoves[1])) {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                        else {
                            if (possibleCaptures.length > 1) {
                                if ((this.isEqualByCol(possibleCaptures[0], possibleCaptures[1]))) {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                                else {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                    }
                }
            }
        }
        this.pgn = this.pgn.trim();
    }
    resolvePieceByFirstChar(move, piece) {
        return MoveUtils.getFirstLetterPiece(piece) === move;
    }
    isEqualByCol(aPiece, bPiece) {
        return aPiece.point.col === bPiece.point.col;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL0tvbXB1dGVyL0Rlc2t0b3AvTm93eSBmb2xkZXIvY2hlc3MtYm9hcmQvcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9lbmdpbmUvcGduL2RlZmF1bHQtcGduLXByb2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBR2hELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVoRSxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsb0JBQW9CO0lBRWxELE9BQU8sQ0FDVixLQUFZLEVBQ1osV0FBa0IsRUFDbEIsU0FBZ0IsRUFDaEIsU0FBaUI7UUFFakIsSUFBSSxDQUFDLFlBQVksSUFBSSxHQUFHLENBQUM7UUFDekIsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUUvRyxJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFFdkIsSUFBSSxTQUFTLEVBQUU7WUFDWCxnQkFBZ0IsR0FBRyxTQUFTLENBQUMscUNBQXFDLENBQzlELFNBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFDakQsS0FBSyxFQUNM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QUM7NkJBQ0w7eUJBQ0o7cUJBQ0o7aUJBQ0o7YUFDSjtTQUNKO1FBRUQsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxJQUFZLEVBQUUsS0FBWTtRQUN0RCxPQUFPLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLENBQUM7SUFDekQsQ0FBQztJQUVPLFlBQVksQ0FBQyxNQUFhLEVBQUUsTUFBYTtRQUM3QyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ2pELENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvYXJkIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2JvYXJkJztcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL2tpbmcnO1xuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcGF3bic7XG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcGllY2UnO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL3BvaW50JztcbmltcG9ydCB7IE1vdmVVdGlscyB9IGZyb20gJy4uLy4uL3V0aWxzL21vdmUtdXRpbHMnO1xuaW1wb3J0IHsgQWJzdHJhY3RQZ25Qcm9jZXNzb3IgfSBmcm9tICcuL2Fic3RyYWN0LXBnbi1wcm9jZXNzb3InO1xuXG5leHBvcnQgY2xhc3MgRGVmYXVsdFBnblByb2Nlc3NvciBleHRlbmRzIEFic3RyYWN0UGduUHJvY2Vzc29yIHtcblxuICAgIHB1YmxpYyBwcm9jZXNzKFxuICAgICAgICBib2FyZDogQm9hcmQsXG4gICAgICAgIHNvdXJjZVBpZWNlOiBQaWVjZSxcbiAgICAgICAgZGVzdFBvaW50OiBQb2ludCxcbiAgICAgICAgZGVzdFBpZWNlPzogUGllY2VcbiAgICApOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jdXJyZW50SW5kZXggKz0gMC41O1xuICAgICAgICB0aGlzLnBnbiArPSAodGhpcy5jdXJyZW50SW5kZXggJSBNYXRoLmZsb29yKHRoaXMuY3VycmVudEluZGV4KSA9PT0gMCkgPyAoJyAnICsgdGhpcy5jdXJyZW50SW5kZXggKyAnLiAnKSA6ICcgJztcblxuICAgICAgICBsZXQgcG9zc2libGVDYXB0dXJlcyA9IFtdO1xuICAgICAgICBsZXQgcG9zc2libGVNb3ZlcyA9IFtdO1xuXG4gICAgICAgIGlmIChkZXN0UGllY2UpIHtcbiAgICAgICAgICAgIHBvc3NpYmxlQ2FwdHVyZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpLFxuICAgICAgICAgICAgICAgIGJvYXJkLFxuICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLmNvbG9yXG4gICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBzb3VyY2VQaWVjZS5jb25zdHJ1Y3Rvci5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBwb3NzaWJsZU1vdmVzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpLFxuICAgICAgICAgICAgYm9hcmQsXG4gICAgICAgICAgICBzb3VyY2VQaWVjZS5jb2xvclxuICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBzb3VyY2VQaWVjZS5jb25zdHJ1Y3Rvci5uYW1lKTtcblxuICAgICAgICBpZiAoc291cmNlUGllY2UgaW5zdGFuY2VvZiBQYXduICYmICFkZXN0UGllY2UgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoc291cmNlUGllY2UgaW5zdGFuY2VvZiBQYXduICYmIGRlc3RQaWVjZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICkuc3Vic3RyaW5nKDAsIDEpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIEtpbmcgJiYgKE1hdGguYWJzKHNvdXJjZVBpZWNlLnBvaW50LmNvbCAtIGRlc3RQb2ludC5jb2wpID09PSAyKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYm9hcmQucmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IGRlc3RQb2ludC5jb2wgPCAyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnTy1PJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ08tTy1PJztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IGRlc3RQb2ludC5jb2wgPCAzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnTy1PLU8nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnTy1PJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgUGF3bikgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDAgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPCAyKSB7ICAgICAvLyBOZjNcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlTW92ZXMgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPT09IDIgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDApIHsgICAgLy8gTmJkN1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRXF1YWxCeUNvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1swXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1sxXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMucmV2ZXJzZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zc2libGVDYXB0dXJlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5pc0VxdWFsQnlDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzWzBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlc1sxXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLnJldmVyc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMuZm9ybWF0Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArICd4JyArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyAneCcgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucGduID0gdGhpcy5wZ24udHJpbSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIobW92ZTogc3RyaW5nLCBwaWVjZTogUGllY2UpIHtcbiAgICAgICAgcmV0dXJuIE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKHBpZWNlKSA9PT0gbW92ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRXF1YWxCeUNvbChhUGllY2U6IFBpZWNlLCBiUGllY2U6IFBpZWNlKSB7XG4gICAgICAgIHJldHVybiBhUGllY2UucG9pbnQuY29sID09PSBiUGllY2UucG9pbnQuY29sO1xuICAgIH1cblxufVxuIl19